<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¢è´§ç³»ç»Ÿ | Pro v5.3</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root { 
            /* Apple Design Colors */
            --app-bg: #F5F5F7;           /* ç³»ç»ŸèƒŒæ™¯ç° */
            --card-bg: #FFFFFF;          /* å¡ç‰‡çº¯ç™½ */
            --primary: #0071e3;          /* Apple Blue */
            --primary-hover: #0077ED;
            --danger: #FF3B30;           /* iOS Red */
            --success: #34C759;          /* iOS Green */
            --text-main: #1D1D1F;        /* è¿‘é»‘ */
            --text-sec: #86868B;         /* æ¬¡çº§ç° */
            --border-light: #E5E5EA;     /* æµ…è¾¹æ¡† */
            --input-bg: #F5F5F7;         /* è¾“å…¥æ¡†èƒŒæ™¯ */
            
            --radius-md: 12px;
            --radius-lg: 18px;
            --shadow-card: 0 4px 12px rgba(0,0,0,0.03);
            --shadow-float: 0 12px 30px rgba(0,0,0,0.12);
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family: -apple-system, BlinkMacSystemFont, "Inter", "PingFang SC", sans-serif; }
        body { background-color: var(--app-bg); color: var(--text-main); line-height: 1.5; padding-bottom: 120px; -webkit-font-smoothing: antialiased; }
        
        /* --- é¡¶éƒ¨å¯¼èˆª --- */
        .navbar { 
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0,0,0,0.08);
            padding: 0.8rem 1.5rem; position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
        }
        .brand { font-size: 1.1rem; font-weight: 600; color: #000; display: flex; align-items: center; gap: 10px; }
        .brand i { color: var(--primary); font-size: 1.2rem; }
        
        /* --- å®¹å™¨ä¸å¡ç‰‡ --- */
        .container { max-width: 960px; margin: 30px auto; padding: 0 20px; animation: slideIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        @keyframes slideIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .card { 
            background: var(--card-bg); border-radius: var(--radius-lg); 
            box-shadow: var(--shadow-card); margin-bottom: 24px; 
            border: 1px solid rgba(0,0,0,0.02); overflow: hidden;
        }
        .card-header { 
            padding: 16px 24px; border-bottom: 1px solid var(--border-light); 
            font-weight: 600; font-size: 0.95rem; color: var(--text-main);
            display: flex; justify-content: space-between; align-items: center; 
            background: #fff;
        }
        .card-body { padding: 24px; }
        
        /* --- è¡¨å•ç¾åŒ– (iPadOS é£æ ¼) --- */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; }
        .form-group label { display: block; font-size: 0.8rem; color: var(--text-sec); margin-bottom: 8px; font-weight: 500; }
        
        .form-control { 
            width: 100%; padding: 12px 14px; 
            border: 1px solid transparent; /* ç§»é™¤é»˜è®¤è¾¹æ¡† */
            background: var(--input-bg);   /* ç°è‰²å¡«å……èƒŒæ™¯ */
            border-radius: 10px; 
            outline: none; font-size: 15px; color: var(--text-main);
            transition: all 0.2s;
        }
        .form-control:focus { 
            background: #fff; 
            border-color: var(--primary); 
            box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.1); 
        }
        .input-wrapper { position: relative; }
        .clear-btn { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #C7C7CC; cursor: pointer; display: none; }
        .form-control:focus + .clear-btn, .form-control:not(:placeholder-shown) + .clear-btn { display: block; }
        
        /* --- è¡¨æ ¼ --- */
        .table-container { overflow-x: auto; }
        .ui-table { width: 100%; border-collapse: collapse; min-width: 800px; }
        .ui-table th { background: #FAFAFA; padding: 12px 16px; text-align: left; font-size: 0.75rem; color: var(--text-sec); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border-light); }
        .ui-table td { padding: 8px 16px; border-bottom: 1px solid var(--border-light); }
        .ui-table input { width: 100%; border: none; padding: 8px; background: transparent; outline: none; font-size: 14px; border-radius: 6px; }
        .ui-table input:focus { background: #E8F0FE; color: var(--primary); }

        /* --- æŒ‰é’® (Apple Style) --- */
        .action-btn { 
            background: white; border: none; padding: 8px 16px; border-radius: 20px; 
            cursor: pointer; display: inline-flex; align-items: center; gap: 6px; 
            font-size: 14px; color: var(--primary); font-weight: 500; transition: all 0.2s; 
            background: rgba(0, 113, 227, 0.08);
        }
        .action-btn:hover { background: rgba(0, 113, 227, 0.15); transform: scale(1.02); }
        .action-btn:active { transform: scale(0.96); }
        
        .btn-sm { padding: 4px 10px; font-size: 12px; border-radius: 6px; background: transparent; }
        .btn-sm:hover { background: rgba(0,0,0,0.05); }

        /* åº•éƒ¨æ‚¬æµ®æ  */
        .bottom-bar { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 800px;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            padding: 12px 24px; 
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15); border: 1px solid rgba(255,255,255,0.5);
            border-radius: 100px; 
            display: flex; justify-content: space-between; align-items: center; z-index: 99; 
        }
        .main-btn { 
            border: none; padding: 12px 28px; border-radius: 30px; cursor: pointer; 
            font-size: 15px; font-weight: 600; color: white;
            transition: all 0.2s; display: flex; gap: 8px; align-items: center;
            box-shadow: 0 4px 10px rgba(0, 113, 227, 0.3);
        }
        .btn-contract { background: var(--primary); }
        .btn-contract:hover { background: #0062c4; transform: translateY(-2px); }
        .btn-order { background: #000000; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .btn-order:hover { background: #333333; transform: translateY(-2px); }

        /* ================= é‡ç‚¹ä¿®å¤ï¼šå¼¹çª—ç³»ç»Ÿ ================= */
        
        /* 1. ä¸šåŠ¡çª—å£ (Z-index 2000) */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(5px);
            z-index: 2000; display: none; opacity: 0; transition: opacity 0.3s ease;
            justify-content: center; align-items: center; /* é»˜è®¤å±…ä¸­ */
        }
        .modal-backdrop.active { opacity: 1; display: flex; }

        .modal-box {
            background: #fff; width: 100%; max-width: 600px; height: 80vh;
            border-radius: 20px; display: flex; flex-direction: column;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
            transform: translateY(50px); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            overflow: hidden;
        }
        .modal-backdrop.active .modal-box { transform: translateY(0); }

        .modal-header {
            padding: 16px 20px; background: #fff; border-bottom: 1px solid var(--border-light);
            display: flex; justify-content: space-between; align-items: center; z-index: 10;
        }
        .modal-title { font-size: 17px; font-weight: 600; }
        .modal-close { font-size: 15px; color: var(--primary); background: none; border: none; cursor: pointer; font-weight: 500;}

        /* 2. è­¦ç¤ºå¼¹çª— (Z-index 3000 - å¿…é¡»é«˜äºä¸šåŠ¡çª—å£) */
        .alert-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.2); /* æµ…è‰²é®ç½© */
            z-index: 3000; display: none; opacity: 0; transition: opacity 0.2s;
            justify-content: center; align-items: center;
        }
        .alert-backdrop.active { opacity: 1; display: flex; }

        .ios-alert-box {
            background: rgba(245, 245, 247, 0.95); /* iOS æ¨¡ç³Šç™½ */
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            width: 270px; border-radius: 14px; text-align: center;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.05), 0 10px 30px rgba(0,0,0,0.2);
            transform: scale(1.1); transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
        }
        .alert-backdrop.active .ios-alert-box { transform: scale(1); }

        .alert-content { padding: 20px 16px 20px; }
        .alert-title { font-size: 17px; font-weight: 600; margin-bottom: 4px; color: #000; }
        .alert-msg { font-size: 13px; color: #000; line-height: 1.4; }

        .alert-actions { display: flex; border-top: 0.5px solid rgba(60, 60, 67, 0.2); }
        .alert-btn { 
            flex: 1; background: transparent; border: none; padding: 12px 0;
            font-size: 17px; color: var(--primary); cursor: pointer; font-weight: 400;
            border-right: 0.5px solid rgba(60, 60, 67, 0.2);
            margin: 0;
        }
        .alert-btn:last-child { border-right: none; }
        .alert-btn:active { background: rgba(0,0,0,0.05); }
        .alert-btn.bold { font-weight: 600; }
        .alert-btn.destructive { color: var(--danger); font-weight: 600; }

        /* åˆ—è¡¨é¡¹ä¼˜åŒ– */
        .list-group { padding: 0 20px 20px; overflow-y: auto; flex: 1; }
        .list-item { 
            padding: 14px 0; border-bottom: 1px solid var(--border-light); 
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
        }
        .list-item:hover .list-info b { color: var(--primary); }
        .list-info b { display: block; font-size: 15px; margin-bottom: 2px; transition: color 0.2s; }
        .list-info small { color: var(--text-sec); font-size: 13px; }

        /* Loading */
        .loading { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); backdrop-filter:blur(10px); z-index:4000; display:none; flex-direction:column; justify-content:center; align-items:center; }
        
        /* Print Styles Reset (Hide from view) */
        .print-area { position: fixed; left: 0; top: 0; transform: translate(-9999px, -9999px); width: 210mm; background: white; padding: 12mm 15mm; font-family: "SimSun", "å®‹ä½“", serif; color: #000; box-sizing: border-box;}
        /* ... PDF Styles (Simplified for brevity, same as before) ... */
        .pdf-title { text-align: center; font-size: 18pt; font-weight: bold; margin-bottom: 10px; letter-spacing: 3px; }
        .pdf-table { width: 100%; border-collapse: collapse; font-size: 8.5pt; margin-bottom: 8px; }
        .pdf-table th, .pdf-table td { border: 1px solid #000; padding: 3px 4px; }
        .order-header { border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: flex-end; }
        .order-title { font-size: 24pt; font-weight: 900; letter-spacing: 5px; }
        .order-table { width: 100%; border-collapse: collapse; font-size: 10pt; margin-bottom: 15px; }
        .order-table th, .order-table td { border: 1px solid #000; padding: 8px; }
        .pdf-info-table { width: 100%; font-size: 9pt; margin-bottom: 8px; }
        .pdf-val { border-bottom: 1px solid #000; padding: 0 5px; display: inline-block; min-width: 50px; text-align: center; font-weight: bold; }
        .pdf-p { font-size: 9pt; line-height: 1.4; margin-bottom: 5px; text-align: justify; }
        .pdf-h1 { font-size: 10pt; font-weight: bold; margin-top: 8px; margin-bottom: 4px; background: #f0f0f0; padding: 2px 5px; border-left: 3px solid #000; }
        .pdf-terms { font-size: 7.5pt; line-height: 1.35; text-align: justify; white-space: pre-wrap; }
        .pdf-sign-area { display: flex; justify-content: space-between; margin-top: 10px; border-top: 1.5px solid #000; padding-top: 8px; }
        .pdf-sign-col { width: 48%; font-size: 9pt; line-height: 1.5; }
        .pdf-sign-title { font-weight: bold; font-size: 10.5pt; margin-bottom: 5px; }
        .pdf-kv { display: flex; margin-bottom: 1px; } .pdf-k { width: 75px; font-weight: bold; flex-shrink: 0;} .pdf-v { flex: 1; word-break: break-all; }
        .order-box { border: 1px solid #000; padding: 10px; margin-bottom: 15px; display: flex; font-size: 10pt; gap: 20px; }
        .order-box-col { flex: 1; display: flex; flex-direction: column; gap: 5px; }
        .order-row { display: flex; } .order-label { font-weight: bold; width: 70px; flex-shrink: 0; }
        .order-sign-box { border-top: 1px solid #000; margin-top: 40px; padding-top: 10px; display: flex; justify-content: space-between; }
        .order-sign-item { width: 40%; text-align: center; } .order-sign-line { border-bottom: 1px solid #000; height: 30px; margin-top: 20px; }
    </style>
</head>
<body>

<div class="loading" id="loading">
    <i class="fas fa-spinner fa-spin" style="font-size:2rem; color:var(--text-sec); margin-bottom:10px"></i>
    <div style="font-size:0.9rem; font-weight:500; color:var(--text-main)">å¤„ç†ä¸­...</div>
</div>

<!-- å¯¼èˆªæ  -->
<nav class="navbar">
    <div class="brand">
        <i class="fas fa-layer-group"></i> 
        <span>Order<span style="font-weight:400">System</span></span>
    </div>
    <div style="display:flex; gap:10px">
        <button onclick="openHistoryModal()" class="action-btn"><i class="fas fa-clock"></i></button>
        <button onclick="openCustModal()" class="action-btn"><i class="fas fa-user-friends"></i></button>
        <button onclick="backupAll()" class="action-btn"><i class="fas fa-cloud-download-alt"></i></button>
        <button onclick="resetAll()" class="action-btn" style="color:var(--danger)"><i class="fas fa-plus"></i></button>
    </div>
</nav>

<datalist id="product-options">
    <option value="æŠ½çº¸ç›’"><option value="åŒæ’ç›’"><option value="æ‰£åº•ç›’"><option value="æ°”å«ç›’"><option value="æŠ½å±‰ç›’"><option value="å¹³ç²˜ç›’"><option value="å¤©åœ°ç›–ç›’"><option value="é£æœºç›’">
</datalist>
<datalist id="material-options">
    <option value="350Gç™½å¡"><option value="250Gç™½å¡"><option value="375Gé“¶å¡"><option value="ç‰›çš®çº¸">
</datalist>
<datalist id="customer-list-options"></datalist>

<div class="container">
    <!-- åŸºç¡€ä¿¡æ¯å¡ç‰‡ -->
    <div class="card">
        <div class="card-header">
            <span>åŸºç¡€ä¿¡æ¯</span>
            <span class="auto-save-status" id="save-status" style="font-size:12px; color:var(--success); display:none">å·²ä¿å­˜</span>
        </div>
        <div class="card-body form-grid">
            <div class="form-group">
                <label>å•æ®ç¼–å·</label>
                <div style="display:flex; gap:10px;">
                    <div class="input-wrapper" style="flex:1">
                        <input type="text" class="form-control" id="c-no" onchange="saveData()">
                        <i class="fas fa-times-circle clear-btn" onclick="clearInput('c-no')"></i>
                    </div>
                    <button class="action-btn" onclick="genNo()" title="ç”Ÿæˆ"><i class="fas fa-sync-alt"></i></button>
                </div>
            </div>
            <div class="form-group"><label>ç­¾çº¦åœ°ç‚¹</label><input type="text" class="form-control" id="c-loc" value="éƒ‘å·" onchange="saveData()"></div>
            <div class="form-group"><label>ç­¾çº¦æ—¥æœŸ</label><input type="date" class="form-control" id="c-date" onchange="saveData()"></div>
            <div class="form-group">
                <label>å®¢æˆ·åç§° (ç”²æ–¹)</label>
                <div class="input-wrapper">
                    <input type="text" class="form-control" id="party-a" list="customer-list-options" 
                           placeholder="é€‰æ‹©æˆ–è¾“å…¥" onchange="onPartyAChange(); saveData()" 
                           style="border-left:3px solid var(--primary)">
                    <i class="fas fa-times-circle clear-btn" onclick="clearInput('party-a')"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- äº§å“å¡ç‰‡ -->
    <div class="card">
        <div class="card-header">
            <span>äº§å“æ˜ç»†</span>
            <button class="action-btn btn-sm" onclick="addRow()" style="color:var(--primary)"><i class="fas fa-plus"></i></button>
        </div>
        <div class="table-container">
            <table class="ui-table">
                <thead>
                    <tr><th width="40" style="text-align:center">#</th><th width="90">æ“ä½œ</th><th>äº§å“åç§°</th><th>æè´¨</th><th>å°ºå¯¸</th><th width="80">æ•°é‡</th><th width="90">å•ä»·</th><th width="100">åˆè®¡</th></tr>
                </thead>
                <tbody id="p-list"></tbody>
            </table>
        </div>
        <div style="padding:20px; background:#fafafa; border-top:1px solid var(--border-light); display:flex; gap:30px; align-items:flex-start;">
            <div style="flex:1;">
                <label style="font-size:12px; color:var(--text-sec); display:block; margin-bottom:6px;">å·¥è‰º/å¤‡æ³¨è¯´æ˜</label>
                <textarea class="form-control" id="craft" rows="2" style="min-height:60px; font-size:13px; background:white" onchange="saveData()"></textarea>
            </div>
            <div style="text-align:right; min-width:180px;">
                <div style="font-size:12px; color:var(--text-sec)">è®¢å•æ€»é¢</div>
                <div style="font-size:1.8rem; font-weight:700; color:var(--text-main); letter-spacing:-0.5px" id="total-display">Â¥0.00</div>
            </div>
        </div>
    </div>

    <!-- æ¡æ¬¾å¡ç‰‡ -->
    <div class="card">
        <div class="card-header">
            <span>æ¡æ¬¾ä¸ç­¾çº¦</span>
        </div>
        <div class="card-body">
             <div class="form-group" style="margin-bottom:24px">
                <label style="color:var(--primary); font-weight:600">æˆ‘æ–¹ä¸»ä½“ (ä¹™æ–¹)</label>
                <select class="form-control" id="party-b-select" onchange="updatePartyB(); saveData()">
                    <option value="moyu">éƒ‘å·å¢¨äºˆæ–‡åŒ–åˆ›æ„æœ‰é™å…¬å¸</option>
                    <option value="xinyun">æ²³å—çœæ–°è¿åŒ…è£…çº¸å“æœ‰é™å…¬å¸</option>
                    <option value="chuangyi">æ²³å—çœåˆ›è‰ºä¼—åˆåŒ…è£…æœ‰é™è´£ä»»å…¬å¸</option>
                </select>
                <input type="hidden" id="sign-b-comp"><input type="hidden" id="sign-b-code">
                <input type="hidden" id="sign-b-bank"><input type="hidden" id="sign-b-acc">
            </div>

            <div class="form-grid">
                <div class="form-group"><label>äº¤è´§æ—¥æœŸ</label><input class="form-control" id="term-date" value="ä»˜æ¬¾åè´¢åŠ¡æ”¶æ¬¾æ¬¡æ—¥èµ· 10 å¤©å‘è´§" onchange="saveData()"></div>
                <div class="form-group"><label>äº¤è´§åœ°å€</label><input class="form-control" id="term-addr" value="ç”²æ–¹æŒ‡å®šåœ°å€" onchange="saveData()"></div>
                <div class="form-group"><label>ç»“ç®—æ–¹å¼</label><input class="form-control" id="term-pay" value="å…¨æ¬¾" onchange="saveData()"></div>
            </div>
            
            <div style="margin-top:20px; border-top:1px dashed var(--border-light); padding-top:20px;">
                <div class="form-group" style="margin-bottom:15px">
                    <label>éªŒæ”¶æ ‡å‡† (åˆåŒæ¡æ¬¾)</label>
                    <textarea class="form-control" id="term-check" rows="3" onchange="saveData()" style="font-size:13px"></textarea>
                </div>
                <div class="form-group">
                    <label>è¿çº¦è´£ä»» (åˆåŒæ¡æ¬¾)</label>
                    <textarea class="form-control" id="term-liab" rows="5" onchange="saveData()" style="font-size:13px"></textarea>
                </div>
            </div>
            
            <div class="form-grid" style="margin-top:24px">
                <div class="form-group"><label>ç”²æ–¹æˆæƒäºº</label><input class="form-control" id="sign-a-user" onchange="saveData()"></div>
                <div class="form-group"><label>ç”²æ–¹ç”µè¯</label><input class="form-control" id="sign-a-phone" onchange="saveData()"></div>
                <div class="form-group"><label>ç”²æ–¹åœ°å€</label><input class="form-control" id="sign-a-addr" onchange="saveData()"></div>
                <div class="form-group"><label>ä¹™æ–¹æˆæƒäºº</label><input class="form-control" id="sign-b-user" onchange="saveData()"></div>
            </div>
        </div>
    </div>
</div>

<div class="bottom-bar">
    <button class="action-btn" onclick="saveToHistory()" style="background:transparent; color:var(--primary); font-weight:600">
        æš‚å­˜
    </button>
    <div style="display:flex; gap:12px;">
        <button class="main-btn btn-contract" onclick="exportContract()">
            åˆåŒ
        </button>
        <button class="main-btn btn-order" onclick="exportOrder()">
            è®¢è´§å•
        </button>
    </div>
</div>

<!-- ================= å¼¹çª—ç³»ç»Ÿ ================= -->

<!-- 1. è­¦ç¤ºå¼¹çª—å®¹å™¨ (Z-Index 3000) -->
<div id="alert-backdrop" class="alert-backdrop">
    <div class="ios-alert-box">
        <div class="alert-content">
            <div id="alert-title" class="alert-title">æç¤º</div>
            <div id="alert-msg" class="alert-msg">å†…å®¹</div>
        </div>
        <div id="alert-actions" class="alert-actions">
            <!-- åŠ¨æ€ç”ŸæˆæŒ‰é’® -->
        </div>
    </div>
</div>

<!-- 2. å®¢æˆ·ç®¡ç†çª—å£ (Z-Index 2000) -->
<div id="cust-modal" class="modal-backdrop">
    <div class="modal-box">
        <div class="modal-header">
            <button class="action-btn btn-sm" onclick="document.getElementById('import-file').click()">å¯¼å…¥</button>
            <span class="modal-title">å®¢æˆ·åˆ—è¡¨</span>
            <button class="modal-close" onclick="closeModal('cust-modal')">å®Œæˆ</button>
        </div>
        <div style="padding:10px 20px 0;">
            <input type="file" id="import-file" style="display:none" onchange="importData(this)">
            <button class="action-btn" onclick="toggleCustForm(true)" style="width:100%; justify-content:center; background:var(--primary); color:white">+ æ·»åŠ æ–°å®¢æˆ·</button>
        </div>
        
        <div id="cust-form-area" style="display:none; background:#F2F2F7; padding:15px; margin:15px 20px; border-radius:12px;">
            <div class="form-grid" style="gap:10px">
                <input class="form-control" id="cust-name" placeholder="å…¬å¸åç§°*" style="background:white">
                <input class="form-control" id="cust-contact" placeholder="è”ç³»äºº" style="background:white">
                <input class="form-control" id="cust-phone" placeholder="ç”µè¯" style="background:white">
                <input class="form-control" id="cust-addr" placeholder="åœ°å€" style="background:white">
            </div>
            <div style="margin-top:10px; display:flex; gap:10px;">
                <button class="action-btn" onclick="toggleCustForm(false)" style="flex:1">å–æ¶ˆ</button>
                <button class="action-btn" onclick="saveCustomer()" style="flex:1; background:var(--primary); color:white;">ä¿å­˜</button>
            </div>
        </div>
        
        <div class="list-group" id="cust-list"></div>
    </div>
</div>

<!-- 3. å†å²è®°å½•çª—å£ (Z-Index 2000) -->
<div id="history-modal" class="modal-backdrop">
    <div class="modal-box">
        <div class="modal-header">
            <div style="width:30px"></div>
            <span class="modal-title">å†å²è®¢å•</span>
            <button class="modal-close" onclick="closeModal('history-modal')">å®Œæˆ</button>
        </div>
        <div style="padding:15px 20px;">
            <input class="form-control" id="history-search" placeholder="ğŸ” æœç´¢å®¢æˆ·æˆ–æ—¥æœŸ" oninput="renderHistoryList()" style="background:#E3E3E8;">
        </div>
        <div class="list-group" id="history-list"></div>
    </div>
</div>

<!-- æ‰“å°æ¨¡æ¿ (ä¿æŒéšè—) -->
<div id="print-contract-container" class="print-area">
    <div class="pdf-title">è®¢ è´§ åˆ åŒ</div>
    <table class="pdf-info-table">
        <tr><td width="40%">åˆåŒç¼–å·ï¼š<span class="pdf-val" id="p-no"></span></td><td width="35%">ç­¾çº¦åœ°ç‚¹ï¼š<span class="pdf-val" id="p-loc"></span></td><td width="25%" align="right">ç­¾çº¦æ—¶é—´ï¼š<span class="pdf-val" id="p-date"></span></td></tr>
        <tr><td colspan="3"><div style="margin-top:5px"><span style="font-weight:bold">ç”²æ–¹ï¼ˆéœ€æ–¹ï¼‰ï¼š</span><span class="pdf-val" style="min-width:200px; text-align:left" id="p-party-a"></span></div><div style="margin-top:2px"><span style="font-weight:bold">ä¹™æ–¹ï¼ˆä¾›æ–¹ï¼‰ï¼š</span><span id="p-party-b-top"></span></div></td></tr>
    </table>
    <div class="pdf-p">ä¾›éœ€åŒæ–¹æœ¬ç€ç›¸äº’ä¿¡ä»»ã€å¹³ç­‰äº’åˆ©çš„åŸåˆ™ï¼Œç»åå•†è¾¾æˆä¸€è‡´ï¼ŒåŒæ–¹å°±å…·ä½“äº‹å®œç­¾è®¢åˆåŒå¦‚ä¸‹ï¼š</div>
    <div class="pdf-h1">ä¸€ã€äº§å“åç§°è§„æ ¼æ•°é‡å¦‚ä¸‹:</div>
    <table class="pdf-table">
        <thead><tr><th width="5%">åº</th><th width="23%">äº§å“åç§°åŠè§„æ ¼</th><th width="18%">æè´¨è¦æ±‚</th><th width="12%">æˆå“å°ºå¯¸</th><th width="12%">æ•°é‡</th><th width="12%">å•ä»·</th><th width="13%">åˆè®¡</th></tr></thead>
        <tbody id="p-tbody"></tbody>
        <tfoot><tr><td colspan="2">äººæ°‘å¸(å¤§å†™)</td><td colspan="3" style="font-weight:bold; text-align:left" id="p-total-cn"></td><td>å°å†™</td><td style="font-weight:bold; text-align:right" id="p-total-num"></td></tr><tr><td colspan="7" style="text-align:left; padding:5px"><span style="font-weight:bold">å·¥è‰ºè¯´æ˜ï¼š</span><span id="p-craft"></span></td></tr></tfoot>
    </table>
    <div class="pdf-p" style="margin-top:5px">
        <span style="font-weight:bold">äºŒã€äº¤è´§æ—¥æœŸï¼š</span><span id="p-del-date"></span><br>
        <span style="font-weight:bold">ä¸‰ã€äº¤è´§åœ°å€åŠè´¹ç”¨æ‰¿æ‹…ï¼š</span><span id="p-del-addr"></span><br>
        <span style="font-weight:bold">å››ã€ç»“ç®—æ–¹å¼ï¼š</span><span id="p-pay"></span>
    </div>
    <div class="pdf-h1">äº”ã€éªŒæ”¶æ ‡å‡†å’Œæ–¹å¼ï¼š</div><div class="pdf-terms" id="p-terms-check"></div>
    <div class="pdf-h1">å…­ã€è¿çº¦è´£ä»»ï¼š</div><div class="pdf-terms" id="p-terms-liab"></div>
    <div class="pdf-sign-area">
        <div class="pdf-sign-col">
            <div class="pdf-sign-title">ç”²æ–¹ï¼ˆéœ€æ–¹ï¼‰</div><div class="pdf-kv"><div class="pdf-k">å•ä½åç§°ï¼š</div><div class="pdf-v" id="p-sign-comp-a"></div></div><div class="pdf-kv"><div class="pdf-k">åœ°å€ï¼š</div><div class="pdf-v" id="p-sign-addr-a"></div></div><div class="pdf-kv"><div class="pdf-k">ç”µè¯ï¼š</div><div class="pdf-v" id="p-sign-phone-a"></div></div><div class="pdf-kv"><div class="pdf-k">æˆæƒç­¾çº¦äººï¼š</div><div class="pdf-v" id="p-sign-user-a"></div></div><div style="margin-top:15px; color:#999; text-align:right; padding-right:20px">(ç›–ç« )</div>
        </div>
        <div class="pdf-sign-col">
            <div class="pdf-sign-title">ä¹™æ–¹ï¼ˆä¾›æ–¹ï¼‰</div><div class="pdf-kv"><div class="pdf-k">å•ä½åç§°ï¼š</div><div class="pdf-v" id="p-sign-comp-b"></div></div><div class="pdf-kv"><div class="pdf-k">ä¿¡ç”¨ä»£ç ï¼š</div><div class="pdf-v" id="p-sign-code-b"></div></div><div class="pdf-kv"><div class="pdf-k">å¼€æˆ·é“¶è¡Œï¼š</div><div class="pdf-v" id="p-sign-bank-b"></div></div><div class="pdf-kv"><div class="pdf-k">å¼€æˆ·è´¦å·ï¼š</div><div class="pdf-v" id="p-sign-acc-b"></div></div><div class="pdf-kv"><div class="pdf-k">æˆæƒç­¾çº¦äººï¼š</div><div class="pdf-v" id="p-sign-user-b"></div></div><div style="margin-top:2px; color:#999; text-align:right; padding-right:20px">(ç›–ç« )</div>
        </div>
    </div>
</div>

<div id="print-order-container" class="print-area">
    <div class="order-header"><div class="order-title">äº§å“è®¢è´§å•</div><div style="text-align:right"><div class="order-sub">NO: <span id="o-no"></span></div><div class="order-sub">Date: <span id="o-date"></span></div></div></div>
    <div class="order-box">
        <div class="order-box-col"><div style="font-weight:bold; font-size:11pt; margin-bottom:5px; border-bottom:1px dashed #ccc;">ä¾›æ–¹ (Seller)</div><div class="order-row"><span class="order-label">å ç§°ï¼š</span><span id="o-seller-name"></span></div><div class="order-row"><span class="order-label">è”ç³»äººï¼š</span><span id="o-seller-contact"></span></div></div>
        <div class="order-box-col"><div style="font-weight:bold; font-size:11pt; margin-bottom:5px; border-bottom:1px dashed #ccc;">éœ€æ–¹ (Buyer)</div><div class="order-row"><span class="order-label">å ç§°ï¼š</span><span id="o-buyer-name"></span></div><div class="order-row"><span class="order-label">è”ç³»äººï¼š</span><span id="o-buyer-contact"></span></div><div class="order-row"><span class="order-label">ç”µ è¯ï¼š</span><span id="o-buyer-phone"></span></div><div class="order-row"><span class="order-label">åœ° å€ï¼š</span><span id="o-buyer-addr"></span></div></div>
    </div>
    <table class="order-table"><thead><tr><th width="5%">NO.</th><th>äº§å“åç§° (Product)</th><th>æè´¨ (Material)</th><th>å°ºå¯¸ (Size)</th><th width="10%">æ•°é‡</th><th width="10%">å•ä»·</th><th width="12%">é‡‘é¢</th></tr></thead><tbody id="o-tbody"></tbody><tfoot><tr><td colspan="4" style="border:none; text-align:right; font-weight:bold; padding-right:10px;">åˆè®¡ (Total):</td><td style="font-weight:bold; text-align:center" id="o-total-qty"></td><td style="border:none;"></td><td style="font-weight:bold; text-align:right" id="o-total-money"></td></tr></tfoot></table>
    <div style="border:1px solid #000; padding:10px; min-height:60px; margin-bottom:15px; font-size:10pt;"><span style="font-weight:bold">å¤‡æ³¨è¯´æ˜ (Notes)ï¼š</span><div id="o-craft" style="white-space: pre-wrap; margin-top:5px;"></div></div>
    <div style="font-size:10pt; line-height:1.6"><div><span style="font-weight:bold">äº¤è´§æ—¥æœŸï¼š</span><span id="o-date-del"></span></div><div><span style="font-weight:bold">æ”¶è´§åœ°å€ï¼š</span><span id="o-addr-del"></span></div><div><span style="font-weight:bold">æ”¶æ¬¾è´¦å·ï¼š</span><span id="o-bank-info"></span></div></div>
    <div class="order-sign-box"><div class="order-sign-item"><div style="font-weight:bold">ä¾›æ–¹ç¡®è®¤</div><div class="order-sign-line"></div><div>(ç›–ç« /Signature)</div></div><div class="order-sign-item"><div style="font-weight:bold">éœ€æ–¹ç¡®è®¤</div><div class="order-sign-line"></div><div>(ç›–ç« /Signature)</div></div></div>
</div>

<script>
    /* ================= å¼‚æ­¥å¼¹çª—é€»è¾‘ (ä¿®å¤ Z-Index) ================= */
    function showDialog(title, msg, buttons) {
        return new Promise((resolve) => {
            const backdrop = document.getElementById('alert-backdrop');
            const actionBox = document.getElementById('alert-actions');
            
            document.getElementById('alert-title').innerText = title || 'æç¤º';
            document.getElementById('alert-msg').innerText = msg || '';
            actionBox.innerHTML = '';

            buttons.forEach(btn => {
                const b = document.createElement('button');
                b.className = `alert-btn ${btn.style || ''}`;
                b.innerText = btn.text;
                b.onclick = () => {
                    backdrop.classList.remove('active');
                    setTimeout(() => resolve(btn.val), 200); // ç­‰å¾…åŠ¨ç”»
                };
                actionBox.appendChild(b);
            });

            backdrop.classList.add('active');
        });
    }

    async function iosAlert(msg) {
        return showDialog('æç¤º', msg, [{text:'å¥½', val:true, style:'bold'}]);
    }

    async function iosConfirm(msg, title='ç¡®è®¤æ“ä½œ') {
        return showDialog(title, msg, [
            {text:'å–æ¶ˆ', val:false},
            {text:'ç¡®å®š', val:true, style:'bold'}
        ]);
    }
    
    async function iosDestructive(msg, title='è­¦å‘Š', actionText='åˆ é™¤') {
        return showDialog(title, msg, [
            {text:'å–æ¶ˆ', val:false},
            {text:actionText, val:true, style:'destructive'}
        ]);
    }

    /* ================= æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ ================= */
    const COMPANY_DATA = {
        "moyu": { name: "éƒ‘å·å¢¨äºˆæ–‡åŒ–åˆ›æ„æœ‰é™å…¬å¸", code: "91410105MAEB8W6Q4M", bank: "ä¸­å›½å·¥å•†é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸éƒ‘å·äºŒåä¸€ä¸–çºªæ”¯è¡Œ", acc: "1702222009100163562", signer: "æ¥šä»•ç…œ" },
        "xinyun": { name: "æ²³å—çœæ–°è¿åŒ…è£…çº¸å“æœ‰é™å…¬å¸", code: "91410105MA9GNE008R", bank: "ä¸­å›½å·¥å•†é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸éƒ‘å·äºŒåä¸€ä¸–çºªæ”¯è¡Œ", acc: "1702222009100057503", signer: "" },
        "chuangyi": { name: "æ²³å—çœåˆ›è‰ºä¼—åˆåŒ…è£…æœ‰é™è´£ä»»å…¬å¸", code: "91410700MAEQMMJQXH", bank: "ä¸­å›½å»ºè®¾é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸æ–°ä¹¡ä¸­åŸå†œè°·æ”¯è¡Œ", acc: "41050163284800002146", signer: "" }
    };
    const DEFAULT_TERMS = {
        check: `1ã€æŒ‰åˆåŒè¦æ±‚æ ·å“ä¿è¯å°åˆ·è´¨é‡å’Œæ•°é‡ï¼Œæ•°é‡è¯¯å·®ä¸ºÂ±10ï¼…ã€‚\n2ã€æ ¹æ®ç”²æ–¹æ‰€å‘æ–‡ä»¶ä¸ºå‡†å°åˆ·å‡ºç‰ˆã€‚\n3ã€æ ¹æ®ç”²æ–¹æ‰€å‘æ–‡ä»¶ä¸ºå‡†ï¼Œè‰²å·®è¯¯å·®ç‡ä¸ºÂ±10ï¼…ã€‚\n4ã€ä¹™æ–¹äº¤ä»˜å°åˆ·å“åï¼Œç”²æ–¹å¦‚æœ‰è´¨é‡å¼‚è®®ï¼Œåº”åœ¨3æ—¥ä»¥å†…ä»¥ä¹¦é¢å½¢å¼å‘ä¹™æ–¹æå‡ºï¼Œå¦åˆ™è§†ä¸ºå…¨éƒ¨äº§å“éªŒæ”¶åˆæ ¼ã€‚\n5ã€ä¹™æ–¹é€è´§åˆ°ç”²æ–¹ï¼Œç”±ç”²æ–¹å§”æ‰˜ç›¸å…³äººå‘˜ç­¾å­—æ¥æ”¶ã€ä¸€å¾‹è§†ä¸ºç”²æ–¹å…¬å¸è¡Œä¸ºã€ä¸€åˆ‡åæœæœ‰ç”²æ–¹å…¬å¸æ‰¿æ‹…ã€‚\n6ã€ä»˜æ¬¾å’Œäº¤ä»˜æ–¹å¼ï¼šç”²æ–¹å‘ä¹™æ–¹äº¤ä»˜é¢è´°ä»Ÿè‚†ä½°å…ƒæ•´ã€‚\n7ã€å…¶ä»–ï¼šæ¥ç¨¿ç”Ÿäº§ï¼ŒæŒ‰æ–‡ä»¶å°åˆ·ç”Ÿäº§ã€‚`,
        liab: `1ã€ç”²æ–¹å¦‚ä¸­é€”å˜æ›´å°å“çš„æ•°é‡ã€è§„æ ¼å’Œå†…å®¹ï¼Œåº”æ‰¿æ‹…ä¹™æ–¹å·²åŠ å·¥ç”Ÿäº§çš„ç›¸å…³è´¹ç”¨ï¼Œäº¤è´§æ—¥æœŸé‡æ–°è®¡ç®—ã€‚
2ã€ç”²æ–¹ä¸­é€”è§£é™¤åˆåŒï¼Œåº”æ‰¿æ‹…ä¹™æ–¹ä¸ºå±¥è¡Œæœ¬åˆåŒé€ æˆçš„å…¨éƒ¨æŸå¤±ï¼ˆåŒ…æ‹¬è®¾è®¡ã€åˆ¶ä½œæ‰“æ ·ã€äººå·¥åŠåŸææ–™ç­‰è´¹ç”¨åŠæˆæœ¬æŸå¤±ï¼‰ã€‚æ‰€äº¤è®¢é‡‘ä¸äºˆé€€å›ã€‚
3ã€ä¹™æ–¹åº”æŒ‰æ—¶å°†è´§é€å¾€åŒæ–¹çº¦å®šçš„äº¤è´§åœ°ç‚¹ï¼Œå¦‚å› è´¨é‡é—®é¢˜é€ æˆç”²æ–¹æ‹’ç»æè´§ï¼Œæ‰€é€ æˆçš„æŸå¤±åº”ç”±ä¹™æ–¹æ‰¿æ‹…ã€‚å¦‚éè´¨é‡é—®é¢˜é€ æˆç”²æ–¹æ‹’ç»æè´§ï¼Œæ‰€é€ æˆçš„æŸå¤±ç”±ç”²æ–¹æ‰¿æ‹…ã€‚è‹¥ä¹™æ–¹ä¸æŒ‰çº¦å®šæ—¶é—´äº¤è´§ï¼ŒæŒ‰åˆåŒçº¦å®šè´§æ¬¾æ€»æ¬¾æ—¥5â€°æ‰¿æ‹…è¿çº¦é‡‘ã€‚è‹¥ç”²æ–¹éœ€è¦çš„è´§å“ä¹™æ–¹æŒ‰æœŸå®Œæˆåï¼Œå› ç”²æ–¹åŸå› ä¸æè´§ï¼Œç”²æ–¹åº”æ‰¿æ‹…è¯¥ç¬”å…¨éƒ¨è´§æ¬¾ä»¥åŠå› è´§ç‰©åº“å­˜å¯¼è‡´çš„è´§æ¬¾ä»·æ¬¾åˆ©æ¯åŠä»“åº“è´¹ç”¨ï¼Œå¯¹æ­¤ä¹™æ–¹æœ‰æƒå‘ç”²æ–¹ä¸»å¼ ä¸Šè¿°å…¨éƒ¨å®é™…ç›´æ¥æŸå¤±ä»¥åŠé—´æ¥æŸå¤±è¯‰è®¼ã€‚
4ã€ç”²æ–¹åº”ä¿è¯æ‰€æä¾›çš„è®¾è®¡å°åˆ·èµ„æ–™æ‹¥æœ‰è‡ªä¸»çŸ¥è¯†äº§æƒå’Œåˆæ³•ä½¿ç”¨æƒï¼Œç‰ˆæƒå½’ç”²æ–¹æ‰€æœ‰ï¼Œç”±æ­¤å‘ç”Ÿçš„æ³•å¾‹è´£ä»»ç”±ç”²æ–¹è´Ÿè´£ï¼Œé€ æˆä¹™æ–¹çš„æŸå¤±ç”±ç”²æ–¹èµ”å¿ã€‚
5ã€ä¹™æ–¹å¯¹ç”²æ–¹è®¾è®¡å°åˆ·çš„äº§å“è®¾è®¡æä¾›ç”²æ–¹ä»¥å¤–çš„ç¬¬ä¸‰è€…ï¼Œä¸å¾—å°†ç”²æ–¹å°åˆ·äº§å“è‡ªä¹™æ–¹æ¸ é“æµé€šã€‚ç”²æ–¹æä¾›çš„åˆ¶ä½œæ–‡ä»¶ï¼Œå¦‚æœ‰çŸ¥è¯†äº§æƒã€ç‰ˆæƒçº çº·çš„ï¼Œç”²æ–¹è´Ÿè´£åè°ƒå¤„ç†ï¼Œæ‰¿æ‹…ä¸€åˆ‡å¸¦æ¥çš„æŸå¤±ã€‚ä¹™æ–¹ä¸æ‰¿æ‹…å› çŸ¥è¯†äº§æƒå’Œç‰ˆæƒå¸¦æ¥çš„ä¸€åˆ‡è´£ä»»ã€‚
6ã€ä¹™æ–¹åº”ä¿è¯å°åˆ·è´¨é‡ï¼Œä¸¥æ ¼æŒ‰ç”²æ–¹æ‰€ç­¾æ ·å“ä¸ºå‡†ï¼Œåœ¨æŠ€æœ¯å‡†è®¸çš„è¯¯å·®èŒƒå›´å†…å®Œæˆå°åˆ¶å·¥ä½œã€‚
7ã€ç”²æ–¹åº”æŒ‰åˆåŒè§„å®šæ—¶é—´æ”¯ä»˜ç»™ä¹™æ–¹è´§æ¬¾ï¼Œå¦‚è‹¥é€¾æœŸæ”¯ä»˜ï¼ŒæŒ‰åˆåŒæ€»é¢æ—¥5â€°å‘ä¹™æ–¹æ”¯ä»˜è¿çº¦é‡‘ï¼Œç›´è‡³ä»˜æ¸…ä¸ºæ­¢ã€‚
8ã€æœ¬åˆåŒå±¥è¡Œè¿‡ç¨‹ä¸­å¦‚å› ä¸å¯æŠ—åŠ›çš„åŸå› å½±å“å±¥è¡Œçš„ï¼Œåº”åœ¨ä¸å¯æŠ—åŠ›å‘ç”Ÿå3æ—¥å†…é€šçŸ¥å¯¹æ–¹ï¼Œåå•†è§£å†³ã€‚
9ã€ç”²ã€ä¹™åŒæ–¹åœ¨å±¥è¡ŒåˆåŒè¿‡ç¨‹ä¸­ï¼Œå¦‚å‘ç”Ÿçº çº·ï¼ŒåŒæ–¹åº”æœ¬ç€å‹å¥½åˆä½œçš„ç²¾ç¥ï¼Œé‡‡å–æœ‰æ•ˆçš„æ–¹å¼åå•†è§£å†³ï¼Œå¦‚åå•†ä¸æˆï¼Œç»åŒæ–¹åŒæ„ï¼Œç”±ä¹™æ–¹æ‰€åœ¨åœ°äººæ°‘æ³•é™¢è¯‰è®¼è§£å†³ã€‚
10ã€æœ¬åˆåŒä¸€å¼ä¸¤ä»½ï¼Œç”²ã€ä¹™åŒæ–¹å…±åŒæ‰§æœ‰ï¼Œå…·æœ‰åŒç­‰çš„æ³•å¾‹æ•ˆåŠ›ã€‚
11ã€æœ‰å…³ä¸å±¥è¡Œæœ¬åˆåŒæœ‰å…³çš„ä¼ çœŸä»¶ã€æ‰«æä»¶ã€å¾®ä¿¡æˆªå›¾éƒ½æ˜¯æœ¬åˆåŒç»„æˆéƒ¨åˆ†å…·æœ‰åŒç­‰æ³•å¾‹æ•ˆåŠ›ã€‚
12ã€æœ¬åˆåŒè‡ªåŒæ–¹ç­¾ç« ä¹‹æ—¥èµ·ç”Ÿæ•ˆã€‚`
    };

    let customers = [], historyData = [], editingCustId = null;

    window.onload = function() {
        initCustomers(); initHistory(); initData();
        
        document.getElementById('p-list').addEventListener('input', (e) => {
            if(e.target.tagName !== 'INPUT') return;
            const tr = e.target.closest('tr');
            const qty = parseFloat(tr.querySelector('.p-qty').value) || 0;
            const price = parseFloat(tr.querySelector('.p-price').value) || 0;
            const totalEl = tr.querySelector('.p-total');
            
            if (e.target.classList.contains('p-qty') || e.target.classList.contains('p-price')) {
                if(qty && price) totalEl.value = (Math.round(qty * price * 100) / 100);
            } else if (e.target.classList.contains('p-total')) {
                const total = parseFloat(totalEl.value) || 0;
                if (qty !== 0) tr.querySelector('.p-price').value = (total / qty).toFixed(2);
            }
            calcTotal(); saveData();
        });

        ['term-pay', 'term-addr'].forEach(id => {
            document.getElementById(id).addEventListener('input', () => { updateItem6(); saveData(); });
        });
    };

    // ================= PDF é€»è¾‘ =================
    async function generatePdf(elementId, fileNamePrefix) {
        if(!document.getElementById('party-a').value) { await iosAlert("è¯·å…ˆå¡«å†™å®¢æˆ·åç§°"); return; }
        
        const el = document.getElementById(elementId);
        document.getElementById('loading').style.display = 'flex';
        el.style.transform = "none"; el.style.position = "absolute"; el.style.left = "0"; el.style.top = "0"; el.style.zIndex = "1001";

        try {
            const canvas = await html2canvas(el, { scale: 2, useCORS: true });
            const imgData = canvas.toDataURL('image/jpeg', 0.95);
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfW = 210, pdfH = 297;
            const imgProps = pdf.getImageProperties(imgData);
            const contentH = (imgProps.height * pdfW) / imgProps.width;
            let heightLeft = contentH, position = 0;

            pdf.addImage(imgData, 'JPEG', 0, position, pdfW, contentH);
            heightLeft -= pdfH;
            while (heightLeft > 0) {
                position = heightLeft - contentH;
                pdf.addPage();
                pdf.addImage(imgData, 'JPEG', 0, position, pdfW, contentH);
                heightLeft -= pdfH;
            }
            pdf.save(`${fileNamePrefix}_${document.getElementById('party-a').value}.pdf`);
        } catch(e) { console.error(e); await iosAlert("ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•"); } 
        finally {
            el.style.transform = "translate(-9999px, -9999px)"; el.style.position = "fixed";
            document.getElementById('loading').style.display = 'none';
        }
    }

    async function exportContract() { if(!await commonCheck()) return; await saveToHistory(true); fillPrintData('contract'); await generatePdf('print-contract-container', 'åˆåŒ'); }
    async function exportOrder() { if(!await commonCheck()) return; await saveToHistory(true); fillPrintData('order'); await generatePdf('print-order-container', 'è®¢è´§å•'); }

    async function commonCheck() { if(!document.getElementById('party-a').value) { await iosAlert("è¯·å…ˆå¡«å†™å®¢æˆ·åç§°"); return false; } return true; }

    function fillPrintData(type) {
        const map = {
            'c-no': ['p-no', 'o-no'], 'c-loc': ['p-loc'], 'c-date': ['p-date', 'o-date'],
            'party-a': ['p-party-a', 'o-buyer-name', 'p-sign-comp-a'],
            'sign-b-comp': ['p-party-b-top', 'o-seller-name', 'p-sign-comp-b'],
            'craft': ['p-craft', 'o-craft'],
            'term-date': ['p-del-date', 'o-date-del'], 'term-addr': ['p-del-addr', 'o-addr-del'], 'term-pay': ['p-pay'],
            'term-check': ['p-terms-check'], 'term-liab': ['p-terms-liab'],
            'sign-a-addr': ['p-sign-addr-a', 'o-buyer-addr'], 'sign-a-phone': ['p-sign-phone-a', 'o-buyer-phone'], 'sign-a-user': ['p-sign-user-a', 'o-buyer-contact'],
            'sign-b-code': ['p-sign-code-b'], 'sign-b-bank': ['p-sign-bank-b'], 'sign-b-acc': ['p-sign-acc-b'], 'sign-b-user': ['p-sign-user-b', 'o-seller-contact']
        };

        for(let srcId in map) {
            const val = document.getElementById(srcId).value;
            map[srcId].forEach(targetId => {
                const el = document.getElementById(targetId);
                if(el) {
                    if(srcId === 'c-date') el.innerText = formatDateCN(val);
                    else el.innerText = val;
                }
            });
        }
        document.getElementById('o-bank-info').innerText = `${document.getElementById('sign-b-bank').value} (${document.getElementById('sign-b-acc').value})`;

        const tbodyId = type === 'contract' ? 'p-tbody' : 'o-tbody';
        const tbody = document.getElementById(tbodyId);
        tbody.innerHTML = '';
        document.querySelectorAll('#p-list tr').forEach((tr, i) => {
            const inps = tr.querySelectorAll('input');
            const rowStr = type === 'contract' 
                ? `<td style="text-align:center">${i+1}</td><td>${inps[0].value}</td><td>${inps[1].value}</td><td style="text-align:center">${inps[2].value}</td><td style="text-align:center">${inps[3].value}</td><td style="text-align:right">${inps[4].value}</td><td style="text-align:right">${inps[5].value}</td>`
                : `<td style="text-align:center">${i+1}</td><td>${inps[0].value}</td><td>${inps[1].value}</td><td style="text-align:center">${inps[2].value}</td><td style="text-align:center">${inps[3].value}</td><td style="text-align:center">${inps[4].value}</td><td style="text-align:right">${inps[5].value}</td>`;
            const newTr = document.createElement('tr'); newTr.innerHTML = rowStr; tbody.appendChild(newTr);
        });

        const { sum, count } = calcTotal();
        if(type === 'contract') {
            document.getElementById('p-total-cn').innerText = n2c(sum);
            document.getElementById('p-total-num').innerText = 'Â¥' + sum.toLocaleString('en-US', {minimumFractionDigits: 2});
        } else {
            document.getElementById('o-total-qty').innerText = count;
            document.getElementById('o-total-money').innerText = 'Â¥' + sum.toLocaleString('en-US', {minimumFractionDigits: 2});
        }
    }

    // ================= å†å²/å®¢æˆ· =================
    function initHistory() { const saved = localStorage.getItem('orderSys_history'); if(saved) historyData = JSON.parse(saved); }
    
    async function saveToHistory(silent = false) {
        const currentData = collectCurrentData(); 
        if(!currentData.partyA) { if(!silent) await iosAlert("è¯·å…ˆå¡«å†™å®¢æˆ·åç§°"); return; }
        
        const last = historyData[0];
        const isUpdate = last && last.data.no === currentData.no && (Date.now() - last.id < 120000);

        if(isUpdate) {
            historyData[0].data = currentData;
            historyData[0].total = document.getElementById('total-display').innerText;
        } else {
            const record = { id: Date.now(), date: new Date().toLocaleString(), client: currentData.partyA, total: document.getElementById('total-display').innerText, data: currentData };
            historyData.unshift(record); if(historyData.length > 50) historyData.pop(); 
        }
        
        localStorage.setItem('orderSys_history', JSON.stringify(historyData));
        if(!silent) {
            const status = document.getElementById('save-status');
            status.style.display = 'inline';
            setTimeout(() => status.style.display='none', 2000);
        }
    }

    function openHistoryModal() { document.getElementById('history-modal').classList.add('active'); renderHistoryList(); }
    function renderHistoryList() {
        const term = document.getElementById('history-search').value.toLowerCase(); 
        const box = document.getElementById('history-list'); box.innerHTML = '';
        const filtered = historyData.filter(h => h.client.toLowerCase().includes(term) || h.date.includes(term));
        
        if(filtered.length === 0) { box.innerHTML = '<div style="text-align:center;color:#999;padding:40px">æ²¡æœ‰è®°å½•</div>'; return; }
        
        filtered.forEach(h => {
            const div = document.createElement('div'); div.className = 'list-item';
            div.innerHTML = `
                <div class="list-info" style="flex:1" onclick="loadHistoryItem(${h.id})"><b>${h.client}</b><small>${h.date} Â· ${h.total}</small></div>
                <button class="action-btn btn-sm" onclick="delHistory(${h.id}, event)" style="color:var(--danger)"><i class="fas fa-trash"></i></button>`;
            box.appendChild(div);
        });
    }

    async function loadHistoryItem(id) { 
        if(await iosConfirm("å½“å‰å†…å®¹å°†è¢«è¦†ç›–ï¼Œç¡®å®šåŠ è½½ï¼Ÿ")) {
            const record = historyData.find(h => h.id === id); 
            if(record) { restoreData(record.data); closeModal('history-modal'); }
        }
    }
    
    async function delHistory(id, e) { 
        e.stopPropagation(); 
        if(await iosDestructive("è®°å½•åˆ é™¤åæ— æ³•æ¢å¤", "ç¡®å®šåˆ é™¤ï¼Ÿ")) { 
            historyData = historyData.filter(h => h.id !== id); 
            localStorage.setItem('orderSys_history', JSON.stringify(historyData)); 
            renderHistoryList(); 
        } 
    }

    function addRow(data={}) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td style="text-align:center;color:#ccc"></td><td style="display:flex; gap:4px; justify-content:center;"><button class="action-btn btn-sm" onclick="moveRow(this, -1)"><i class="fas fa-arrow-up"></i></button><button class="action-btn btn-sm" onclick="moveRow(this, 1)"><i class="fas fa-arrow-down"></i></button><button class="action-btn btn-sm" onclick="removeRow(this)" style="color:var(--danger)"><i class="fas fa-times"></i></button></td><td><input value="${data.name||''}" class="p-name" list="product-options" onchange="saveData()"></td><td><input value="${data.mat||''}" list="material-options" onchange="saveData()"></td><td><input value="${data.size||''}" onchange="saveData()"></td><td><input value="${data.qty||''}" class="p-qty" type="number" onchange="saveData()"></td><td><input value="${data.price||''}" class="text-right p-price" type="number" onchange="saveData()"></td><td><input value="${data.total||''}" class="text-right p-total" type="number" onchange="saveData()"></td>`;
        document.getElementById('p-list').appendChild(tr); updateIdx();
    }
    function moveRow(btn, dir) { const tr = btn.closest('tr'); if (dir === -1 && tr.previousElementSibling) tr.parentNode.insertBefore(tr, tr.previousElementSibling); else if (dir === 1 && tr.nextElementSibling) tr.parentNode.insertBefore(tr.nextElementSibling, tr); updateIdx(); saveData(); }
    function removeRow(btn) { btn.closest('tr').remove(); calcTotal(); saveData(); updateIdx(); }
    function updateIdx() { document.querySelectorAll('#p-list tr').forEach((tr,i)=>tr.cells[0].innerText=i+1); }

    function collectCurrentData() {
        const products = []; document.querySelectorAll('#p-list tr').forEach(tr => { const inps = tr.querySelectorAll('input'); products.push({ name: inps[0].value, mat: inps[1].value, size: inps[2].value, qty: inps[3].value, price: inps[4].value, total: inps[5].value }); });
        return {
            no: document.getElementById('c-no').value, loc: document.getElementById('c-loc').value, date: document.getElementById('c-date').value, partyA: document.getElementById('party-a').value, craft: document.getElementById('craft').value,
            termDate: document.getElementById('term-date').value, termAddr: document.getElementById('term-addr').value, termPay: document.getElementById('term-pay').value, termCheck: document.getElementById('term-check').value, termLiab: document.getElementById('term-liab').value,
            signAAddr: document.getElementById('sign-a-addr').value, signAPhone: document.getElementById('sign-a-phone').value, signAUser: document.getElementById('sign-a-user').value, partyBSelect: document.getElementById('party-b-select').value, signBUser: document.getElementById('sign-b-user').value, products: products
        };
    }

    function restoreData(data) {
        document.getElementById('c-no').value = data.no; document.getElementById('c-loc').value = data.loc; document.getElementById('c-date').value = data.date; document.getElementById('party-a').value = data.partyA; document.getElementById('craft').value = data.craft;
        document.getElementById('term-date').value = data.termDate; document.getElementById('term-addr').value = data.termAddr; document.getElementById('term-pay').value = data.termPay;
        document.getElementById('term-check').value = data.termCheck || DEFAULT_TERMS.check; 
        document.getElementById('term-liab').value = data.termLiab || DEFAULT_TERMS.liab;
        document.getElementById('sign-a-addr').value = data.signAAddr || ''; document.getElementById('sign-a-phone').value = data.signAPhone || ''; document.getElementById('sign-a-user').value = data.signAUser || '';
        if(data.partyBSelect) document.getElementById('party-b-select').value = data.partyBSelect; updatePartyB(false); if(data.signBUser) document.getElementById('sign-b-user').value = data.signBUser;
        const pList = document.getElementById('p-list'); pList.innerHTML = ''; if(data.products && data.products.length) data.products.forEach(p => addRow(p)); else addRow(); calcTotal();
    }

    function backupAll() { const fullBackup = { version: "5.0", timestamp: new Date().toISOString(), current: collectCurrentData(), customers: customers, history: historyData }; const blob = new Blob([JSON.stringify(fullBackup)], {type: "application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); }
    
    function importData(input) { 
        const file = input.files[0]; if(!file) return; 
        const reader = new FileReader(); 
        reader.onload = async function(e) { 
            try { 
                const data = JSON.parse(e.target.result); 
                if(data.version) { 
                    if(await iosConfirm("è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼Ÿ")) { 
                        customers = data.customers || []; historyData = data.history || []; 
                        localStorage.setItem('orderSys_customers', JSON.stringify(customers)); localStorage.setItem('orderSys_history', JSON.stringify(historyData)); 
                        if(data.current) restoreData(data.current); 
                        await iosAlert("æ•°æ®æ¢å¤æˆåŠŸï¼"); 
                    } 
                } else if(Array.isArray(data)) { 
                    customers = data; localStorage.setItem('orderSys_customers', JSON.stringify(customers)); 
                    await iosAlert("å®¢æˆ·åˆ—è¡¨å¯¼å…¥æˆåŠŸ"); 
                } 
                updateCustDatalist(); 
                if(document.getElementById('cust-modal').classList.contains('active')) renderCustList(); 
            } catch(err) { await iosAlert("æ–‡ä»¶æ ¼å¼é”™è¯¯"); } 
        }; 
        reader.readAsText(file); 
    }

    function initData() { const saved = localStorage.getItem('orderSys_v1'); if(saved) { try { restoreData(JSON.parse(saved)); } catch(e){ resetAll(); } } else { resetAll(false); } }
    function saveData() { localStorage.setItem('orderSys_v1', JSON.stringify(collectCurrentData())); }
    
    async function resetAll(confirmFlag=true) { 
        if(confirmFlag) if(!await iosDestructive("å½“å‰é¡µé¢å°†è¢«æ¸…ç©º", "ç¡®å®šå¼€æ–°å•å—ï¼Ÿ", "æ¸…ç©º")) return;
        genNo(); document.getElementById('c-date').value = new Date().toISOString().split('T')[0]; 
        document.getElementById('term-check').value = DEFAULT_TERMS.check; 
        document.getElementById('term-liab').value = DEFAULT_TERMS.liab; 
        document.getElementById('p-list').innerHTML = ''; updatePartyB(); addRow({name:'åŒæ’ç›’',mat:'350Gç™½å¡'}); updateItem6(); calcTotal(); 
    }

    function initCustomers() { const c = localStorage.getItem('orderSys_customers'); if(c) customers = JSON.parse(c); updateCustDatalist(); }
    function updateCustDatalist() { document.getElementById('customer-list-options').innerHTML = customers.map(c=>`<option value="${c.name}">`).join(''); }
    function onPartyAChange() { const val = document.getElementById('party-a').value; const c = customers.find(i=>i.name===val); if(c) { document.getElementById('sign-a-user').value = c.contact; document.getElementById('sign-a-phone').value = c.phone; document.getElementById('sign-a-addr').value = c.addr; saveData(); } }
    
    function openCustModal() { document.getElementById('cust-modal').classList.add('active'); renderCustList(); toggleCustForm(false); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); updateCustDatalist(); }
    
    function renderCustList() { 
        const box = document.getElementById('cust-list'); box.innerHTML = ''; 
        customers.forEach((c,i)=>{ 
            const div = document.createElement('div'); div.className = 'list-item'; 
            div.innerHTML = `
            <div class="list-info" style="flex:1" onclick="fillCust(${i})"><b>${c.name}</b><small>${c.contact||'-'} | ${c.phone||'-'}</small></div>
            <div style="display:flex; gap:10px">
                <button class="action-btn btn-sm" onclick="editCust(${i})"><i class="fas fa-pen"></i></button>
                <button class="action-btn btn-sm" onclick="delCust(${i})" style="color:var(--danger)"><i class="fas fa-trash"></i></button>
            </div>`; 
            box.appendChild(div); 
        }); 
    }
    
    function fillCust(i) { document.getElementById('party-a').value = customers[i].name; onPartyAChange(); closeModal('cust-modal'); }
    
    async function saveCustomer() { 
        const name = document.getElementById('cust-name').value; if(!name) { await iosAlert("è¯·å¡«å†™å…¬å¸åç§°"); return; }
        const obj = { name, contact: document.getElementById('cust-contact').value, phone: document.getElementById('cust-phone').value, addr: document.getElementById('cust-addr').value }; 
        if(editingCustId !== null) customers[editingCustId] = obj; else customers.push(obj); 
        localStorage.setItem('orderSys_customers', JSON.stringify(customers)); 
        renderCustList(); toggleCustForm(false); 
    }
    
    function editCust(i) { toggleCustForm(true); const c = customers[i]; document.getElementById('cust-name').value = c.name; document.getElementById('cust-contact').value = c.contact; document.getElementById('cust-phone').value = c.phone; document.getElementById('cust-addr').value = c.addr; editingCustId = i; }
    
    async function delCust(i) { 
        if(await iosDestructive("åˆ é™¤è¯¥å®¢æˆ·èµ„æ–™ï¼Ÿ")) { 
            customers.splice(i,1); localStorage.setItem('orderSys_customers', JSON.stringify(customers)); renderCustList(); 
        } 
    }
    
    function toggleCustForm(show) { document.getElementById('cust-form-area').style.display = show ? 'block' : 'none'; if(show) { editingCustId = null; document.querySelectorAll('#cust-form-area input').forEach(i=>i.value=''); } }
    
    function updatePartyB(resetSigner=true) { const k = document.getElementById('party-b-select').value; const d = COMPANY_DATA[k]; document.getElementById('sign-b-comp').value = d.name; document.getElementById('sign-b-code').value = d.code; document.getElementById('sign-b-bank').value = d.bank; document.getElementById('sign-b-acc').value = d.acc; if(resetSigner) document.getElementById('sign-b-user').value = d.signer; }
    function genNo() { const d = new Date(); document.getElementById('c-no').value = `HNMY-${d.getFullYear()}${(d.getMonth()+1).toString().padStart(2,'0')}${d.getDate().toString().padStart(2,'0')}${Math.floor(Math.random()*90)+10}`; saveData(); }
    function calcTotal() { let sum = 0, count = 0; document.querySelectorAll('.p-total').forEach(e => sum += parseFloat(e.value)||0); document.querySelectorAll('.p-qty').forEach(e => count += parseFloat(e.value)||0); sum = Math.round(sum*100)/100; document.getElementById('total-display').innerText = 'Â¥' + sum.toLocaleString('en-US', {minimumFractionDigits: 2}); return {sum, count}; }
    function updateItem6() { const pay = document.getElementById('term-pay').value || 'å…¨æ¬¾'; const addr = document.getElementById('term-addr').value || 'ç”²æ–¹æŒ‡å®šåœ°å€'; const el = document.getElementById('term-check'); let txt = el.value; const replace = `6ã€ä»˜æ¬¾å’Œäº¤ä»˜æ–¹å¼ï¼šç»“ç®—æ–¹å¼ä¸ºâ€œ${pay}â€ï¼Œäº¤è´§åœ°ç‚¹ä¸ºâ€œ${addr}â€ã€‚`; const reg = /6ã€ä»˜æ¬¾å’Œäº¤ä»˜æ–¹å¼ï¼š[\s\S]*?(?=\n7ã€|$)/; if(reg.test(txt)) el.value = txt.replace(reg, replace); }
    function clearInput(id) { document.getElementById(id).value=''; saveData(); }
    function n2c(n) { if(!n || n==0) return "é›¶å…ƒæ•´"; let unit = "ä»Ÿä½°æ‹¾äº¿ä»Ÿä½°æ‹¾ä¸‡ä»Ÿä½°æ‹¾å…ƒè§’åˆ†", str = ""; n += "00"; let p = n.indexOf('.'); if (p >= 0) n = n.substring(0, p) + n.substr(p+1, 2); unit = unit.substr(unit.length - n.length); for (let i=0; i < n.length; i++) str += 'é›¶å£¹è´°åè‚†ä¼é™†æŸ’æŒç–'.charAt(n.charAt(i)) + unit.charAt(i); return str.replace(/é›¶(ä»Ÿ|ä½°|æ‹¾|è§’)/g, "é›¶").replace(/(é›¶)+/g, "é›¶").replace(/é›¶(ä¸‡|äº¿|å…ƒ)/g, "$1").replace(/(äº¿)ä¸‡|å£¹(æ‹¾)/g, "$1$2").replace(/^å…ƒé›¶?|é›¶åˆ†/g, "").replace(/å…ƒ$/g, "å…ƒæ•´"); }
    function formatDateCN(s) { if(!s) return ''; const d=new Date(s); return `${d.getFullYear()} å¹´ ${d.getMonth()+1} æœˆ ${d.getDate()} æ—¥`; }
</script>
</body>
</html>
