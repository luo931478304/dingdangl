<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¡æ ¸ç³»ç»Ÿ | Back4Appå…è®¤è¯ç‰ˆ</title>
    <!-- å¼•å…¥ Parse SDK (Back4App æ ¸å¿ƒ) -->
    <script src="https://npmcdn.com/parse/dist/parse.min.js"></script>
    <style>
        /* --- ä¿æŒé«˜çº§ Aurora UI ä¸å˜ --- */
        :root {
            --primary: #6366f1;
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --bg-body: #f0f2f5;
            --glass-bg: rgba(255, 255, 255, 0.9);
            --glass-border: 1px solid rgba(255, 255, 255, 0.8);
            --text-main: #1e293b; --text-sub: #64748b;
        }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; padding: 20px; color: var(--text-main); min-height: 100vh;
            background-color: var(--bg-body);
            background-image: radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.1) 0%, transparent 40%), radial-gradient(circle at 90% 80%, rgba(236, 72, 153, 0.1) 0%, transparent 40%);
            background-attachment: fixed;
        }
        .container { max-width: 1000px; margin: 0 auto; padding-bottom: 40px; }
        
        /* å¯¼èˆª */
        .nav-wrapper { display: flex; justify-content: center; margin-bottom: 30px; }
        .nav-tabs { background: rgba(255,255,255,0.8); backdrop-filter: blur(12px); padding: 5px; border-radius: 99px; border: var(--glass-border); display: inline-flex; gap: 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .nav-btn { border: none; background: transparent; padding: 10px 24px; border-radius: 99px; font-size: 14px; font-weight: 700; color: var(--text-sub); cursor: pointer; transition: 0.3s; }
        .nav-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

        /* å¡ç‰‡ */
        .page-section { display: none; animation: fadeIn 0.4s ease; } .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .glass-card { background: var(--glass-bg); backdrop-filter: blur(20px); border: var(--glass-border); border-radius: 20px; padding: 30px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); margin-bottom: 24px; }
        h2 { margin: 0 0 24px 0; font-size: 22px; font-weight: 800; display: flex; align-items: center; gap: 10px; }
        h2::before { content:''; width: 6px; height: 24px; background: var(--primary-gradient); border-radius: 10px; display: block; }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .kpi-card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .kpi-card:hover { transform: translateY(-3px); }
        .kpi-label { font-size: 13px; color: var(--text-sub); font-weight: 600; text-transform: uppercase; }
        .kpi-value { font-size: 26px; font-weight: 800; margin-top: 4px; }
        
        .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px; margin-bottom: 24px; }
        .chart-card { background: white; border-radius: 20px; padding: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .bar-group { margin-bottom: 12px; }
        .bar-bg { height: 8px; background: #f1f5f9; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .bar-fill { height: 100%; border-radius: 4px; background: var(--primary-gradient); width: 0; transition: width 1s ease; }
        
        /* è¡¨å• */
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 12px; font-weight: 700; color: var(--text-sub); }
        .form-control { width: 100%; padding: 14px; border: 1px solid #e2e8f0; border-radius: 12px; background: rgba(255,255,255,0.8); transition: 0.2s; }
        .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99,102,241,0.1); background: white; }
        .btn-main { width: 100%; padding: 16px; border: none; border-radius: 14px; background: var(--primary-gradient); color: white; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 8px 20px -5px rgba(99, 102, 241, 0.4); transition: 0.2s; }
        .btn-main:hover { transform: translateY(-2px); }

        /* ä¸Šä¼  */
        .upload-zone { border: 2px dashed #cbd5e1; border-radius: 16px; padding: 30px; text-align: center; cursor: pointer; background: rgba(248, 250, 252, 0.5); }
        .preview-box { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .thumb-wrap { width: 70px; height: 70px; border-radius: 10px; overflow: hidden; position: relative; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .thumb-wrap img { width: 100%; height: 100%; object-fit: cover; }
        .thumb-rm { position: absolute; inset: 0; background: rgba(0,0,0,0.5); color: white; display: flex; justify-content: center; align-items: center; cursor: pointer; opacity: 0; transition: 0.2s; }
        .thumb-wrap:hover .thumb-rm { opacity: 1; }

        /* è¡¨æ ¼ & ç­›é€‰ */
        .filter-bar { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .btn-tool { padding: 10px 18px; border-radius: 10px; font-weight: 600; cursor: pointer; border: 1px solid #e2e8f0; background: white; }
        .btn-export { background: #ecfdf5; color: #047857; border:none; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 16px; background: #f8fafc; font-size: 12px; color: var(--text-sub); }
        td { padding: 16px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        .badge { padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; display: inline-block; }
        .badge-auditor { background: #eff6ff; color: #2563eb; } .badge-resp { background: #fff1f2; color: #e11d48; }

        /* åŠŸèƒ½ç»„ä»¶ */
        #loadingMask { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(5px); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #toast { position: fixed; top: 20px; right: 20px; z-index: 5000; background: white; padding: 16px 24px; border-radius: 14px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-left: 5px solid var(--primary); transform: translateX(150%); transition: 0.4s; font-weight:600; }
        #toast.show { transform: translateX(0); }
        
        /* è®¾ç½®æ ‡ç­¾ */
        .tag-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px; }
        .tag { background: #f1f5f9; padding: 6px 12px; border-radius: 8px; font-size: 13px; cursor: pointer; transition:0.2s; }
        .tag:hover { background: #fee2e2; color: #991b1b; }

        /* å›¾ç‰‡æ”¾å¤§ */
        #imgModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 5000; justify-content: center; align-items: center; }
        #imgModal img { max-width: 90%; max-height: 90%; border-radius: 10px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }

        @media (max-width: 600px) { .form-row { grid-template-columns: 1fr; } .glass-card { padding: 20px; } }
    </style>
</head>
<body>

<!-- Loading -->
<div id="loadingMask">
    <div class="spinner"></div>
    <div style="margin-top:15px; font-weight:600; color:#64748b;">äº‘ç«¯åŒæ­¥ä¸­...</div>
</div>

<div class="container">
    <div class="nav-wrapper">
        <div class="nav-tabs">
            <button class="nav-btn active" onclick="switchTab('add')">âœï¸ ç™»è®°</button>
            <button class="nav-btn" onclick="switchTab('list')">ğŸ“Š æ•°æ®</button>
            <button class="nav-btn" onclick="switchTab('settings')">âš™ï¸ è®¾ç½®</button>
        </div>
    </div>

    <!-- 1. ç™»è®° -->
    <div id="page-add" class="page-section active">
        <div class="glass-card">
            <h2>é—®é¢˜ç™»è®°</h2>
            <form id="auditForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>å®¡æ ¸äººå‘˜</label>
                        <select id="selectAuditor" class="form-control" required><option>åŠ è½½ä¸­...</option></select>
                    </div>
                    <div class="form-group">
                        <label>è´£ä»»å½’å±</label>
                        <select id="selectResponsible" class="form-control" required><option>åŠ è½½ä¸­...</option></select>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom:20px;">
                    <label>å¼‚å¸¸è¯¦æƒ…</label>
                    <textarea id="inputReason" class="form-control" placeholder="æè¿°é—®é¢˜..." required></textarea>
                </div>
                <div class="form-group" style="margin-bottom:30px;">
                    <label>å‡­è¯ä¸Šä¼  (æ”¯æŒå¤šå›¾/ç²˜è´´)</label>
                    <input type="file" id="fileInput" multiple accept="image/*" style="display:none;" onchange="handleFiles(this.files)">
                    <div class="upload-zone" id="pasteArea" onclick="document.getElementById('fileInput').click()">
                        ğŸ“¸ ç‚¹å‡»ä¸Šä¼  æˆ– Ctrl+V ç²˜è´´
                    </div>
                    <div class="preview-box" id="previewContainer"></div>
                </div>
                <button type="submit" class="btn-main">æäº¤ (Back4App)</button>
            </form>
        </div>
    </div>

    <!-- 2. æ•°æ® -->
    <div id="page-list" class="page-section">
        <div class="kpi-grid" id="kpiArea" style="display:none;"></div>
        <div class="chart-grid" id="chartArea" style="display:none;">
            <div class="chart-card">
                <div style="font-weight:700; margin-bottom:15px;">ğŸ† è´£ä»»å æ¯”</div>
                <div id="statProgressArea"></div>
            </div>
            <div class="chart-card">
                <div style="font-weight:700; margin-bottom:15px;">ğŸ”¥ é«˜é¢‘é—®é¢˜</div>
                <div id="statReasonList"></div>
            </div>
        </div>
        <div class="glass-card">
            <div class="filter-bar">
                <div style="flex:1"><input type="date" id="filterDateStart" class="form-control"></div>
                <div style="flex:1"><input type="date" id="filterDateEnd" class="form-control"></div>
                <div style="flex:1"><input type="text" id="filterKeyword" class="form-control" placeholder="æœç´¢ å§“å/å†…å®¹..."></div>
                <button class="btn-tool" onclick="fetchCloudData()">ğŸ”„ åˆ·æ–°</button>
                <button class="btn-tool btn-export" onclick="exportToExcel()">ğŸ“¥ å¯¼å‡º</button>
            </div>
            <div style="overflow-x: auto;">
                <table id="dataTable">
                    <thead><tr><th>æ—¶é—´</th><th>å®¡æ ¸äºº</th><th>è´£ä»»äºº</th><th>è¯¦æƒ…</th><th>å›¾</th><th>æ“ä½œ</th></tr></thead>
                    <tbody id="tableBody"></tbody>
                </table>
                <div id="emptyTip" style="text-align:center; padding:30px; display:none;">æš‚æ— æ•°æ®</div>
            </div>
        </div>
    </div>

    <!-- 3. é…ç½® -->
    <div id="page-settings" class="page-section">
        <div class="glass-card">
            <h3>ğŸ‘¥ å®¡æ ¸äººåå•</h3>
            <div style="display:flex; gap:10px;">
                <input type="text" id="newAuditorInput" class="form-control" placeholder="è¾“å…¥å§“å">
                <button class="btn-tool" style="background:black; color:white;" onclick="addSetting('auditor')">ï¼‹</button>
            </div>
            <div id="auditorList" class="tag-list"></div>
        </div>
        <div class="glass-card" style="margin-top:20px;">
            <h3>ğŸ‘¤ è´£ä»»äººåå•</h3>
            <div style="display:flex; gap:10px;">
                <input type="text" id="newResponsibleInput" class="form-control" placeholder="è¾“å…¥å§“å">
                <button class="btn-tool" style="background:black; color:white;" onclick="addSetting('responsible')">ï¼‹</button>
            </div>
            <div id="responsibleList" class="tag-list"></div>
        </div>
    </div>
</div>

<div id="imgModal" onclick="this.style.display='none'"><img id="modalImg" src=""></div>
<div id="toast"></div>

<script>
    /* ================= âš ï¸ é…ç½®åŒºåŸŸ (Back4App) âš ï¸ ================= */
    // 1. å» Back4App å®˜ç½‘æ³¨å†Œ (é‚®ç®±å³å¯)
    // 2. åˆ›å»º App -> App Settings -> Security & Keys
    // 3. å¤åˆ¶ App ID å’Œ Javascript Key å¡«å…¥ä¸‹é¢
    
    const APP_ID = 'QTPkvJWeuAKzgGlndrzkRiT51VmxLljrP6gj63Wc';
    const JS_KEY = 'jY67lVrsSB309kgNEkV0b6g5EGVk1CY5ZMMTTxg3';
    const ADMIN_PASSWORD = "xinyun123";  // åˆ é™¤/ä¿®æ”¹é…ç½®æ—¶éœ€è¦çš„å¯†ç 

    // =============================================================
    let currentFiles = []; 
    let cloudData = [];
    let cloudSettings = { auditors: [], responsibles: [] };
    let settingsObjId = null;

    document.addEventListener('DOMContentLoaded', async () => {
        if(APP_ID.includes('ä½ çš„')) {
            alert('âŒ è¯·ç”¨è®°äº‹æœ¬æ‰“å¼€ä»£ç ï¼Œå¡«å…¥ Back4App çš„ APP ID å’Œ JS Keyï¼');
            document.getElementById('loadingMask').style.display='none';
            return;
        }

        // åˆå§‹åŒ– Parse
        Parse.initialize(APP_ID, JS_KEY);
        Parse.serverURL = 'https://parseapi.back4app.com/';

        showLoading(true);
        try {
            await fetchSettings();
            updateFormSelects();
            setupPasteEvent();
            setupFilterListeners();
            showLoading(false);
            showToast('âœ… äº‘ç«¯è¿æ¥æˆåŠŸ');
        } catch(e) {
            showLoading(false);
            alert("è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¯†é’¥æ˜¯å¦æ­£ç¡®: " + e.message);
        }
    });

    /* --- æ ¸å¿ƒé€»è¾‘ (Parse) --- */

    // 1. è·å–é…ç½®
    async function fetchSettings() {
        const query = new Parse.Query("AuditSettings");
        try {
            const result = await query.first();
            if (result) {
                cloudSettings = {
                    auditors: result.get("auditors") || [],
                    responsibles: result.get("responsibles") || []
                };
                settingsObjId = result.id;
            } else {
                console.log("æœªæ‰¾åˆ°é…ç½®ï¼Œè¯·å…ˆåœ¨ Back4App åå°åˆ›å»º AuditSettings è¡¨å¹¶æ·»åŠ ä¸€è¡Œæ•°æ®");
                // é»˜è®¤é˜²é”™
                cloudSettings = { auditors: ["è¯·åœ¨åå°æ·»åŠ æ•°æ®"], responsibles: ["è¯·åœ¨åå°æ·»åŠ æ•°æ®"] };
            }
            renderSettingsUI();
        } catch (error) {
            console.error("è·å–é…ç½®å¤±è´¥", error);
        }
    }

    // 2. ä¿å­˜é…ç½®
    async function saveSettingsToCloud() {
        if (!settingsObjId) return alert("é…ç½®æœªåˆå§‹åŒ–ï¼Œæ— æ³•ä¿å­˜");
        showLoading(true);
        
        const Settings = Parse.Object.extend("AuditSettings");
        const settings = new Settings();
        settings.id = settingsObjId;
        
        settings.set("auditors", cloudSettings.auditors);
        settings.set("responsibles", cloudSettings.responsibles);

        try {
            await settings.save();
            updateFormSelects();
            showToast('é…ç½®å·²åŒæ­¥');
        } catch (error) {
            showToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
        }
        showLoading(false);
    }

    // 3. æäº¤è®°å½• (å›¾ç‰‡è½¬ ParseFile)
    async function submitRecord(auditor, responsible, reason) {
        showLoading(true);
        try {
            let imageFiles = [];
            // ä¸Šä¼ å›¾ç‰‡
            if (currentFiles.length > 0) {
                // Back4App çš„æ–‡ä»¶ä¸Šä¼ 
                const uploadPromises = currentFiles.map(file => {
                    const parseFile = new Parse.File(file.name, file);
                    return parseFile.save();
                });
                const savedFiles = await Promise.all(uploadPromises);
                // å­˜ URL æ•°ç»„ï¼ˆè¿™é‡Œç¨å¾®å˜é€šï¼ŒæŠŠ ParseFile å¯¹è±¡å­˜å…¥æ•°ç»„åˆ—ï¼‰
                imageFiles = savedFiles; // å¦‚æœæ•°æ®åº“æ˜¯ Array ç±»å‹ï¼Œå¯ä»¥ç›´æ¥å­˜ ParseFile æ•°ç»„
                // æˆ–è€…è½¬ä¸º url å­—ç¬¦ä¸²æ•°ç»„: imageFiles = savedFiles.map(f => f.url());
                // ä¸ºäº†å…¼å®¹ä¹‹å‰é€»è¾‘ï¼Œè¿™é‡Œå­˜ URL å­—ç¬¦ä¸²
                imageFiles = savedFiles.map(f => f.url());
            }

            const AuditRecord = Parse.Object.extend("AuditRecord");
            const record = new AuditRecord();
            
            record.set("auditor", auditor);
            record.set("responsible", responsible);
            record.set("reason", reason);
            record.set("images", imageFiles);

            await record.save();
            
            document.getElementById('auditForm').reset();
            currentFiles = [];
            document.getElementById('previewContainer').innerHTML = '';
            showToast('æäº¤æˆåŠŸï¼');
        } catch (error) {
            console.error(error);
            showToast('æäº¤å¤±è´¥ï¼š' + error.message, 'error');
        }
        showLoading(false);
    }

    // 4. è·å–æ•°æ®
    async function fetchCloudData() {
        showLoading(true);
        const query = new Parse.Query("AuditRecord");
        query.limit(500);
        query.descending("createdAt");
        
        try {
            const results = await query.find();
            cloudData = results.map(obj => ({
                id: obj.id,
                date: obj.createdAt,
                auditor: obj.get("auditor"),
                responsible: obj.get("responsible"),
                reason: obj.get("reason"),
                images: obj.get("images") || []
            }));
            applyFilters();
            showToast('æ•°æ®å·²åˆ·æ–°');
        } catch (error) {
            showToast('è·å–æ•°æ®å¤±è´¥', 'error');
        }
        showLoading(false);
    }

    // 5. åˆ é™¤æ•°æ®
    async function deleteCloudRecord(id) {
        if(prompt('è¯·è¾“å…¥åˆ é™¤å¯†ç ') !== ADMIN_PASSWORD) return showToast('å¯†ç é”™è¯¯', 'error');
        
        showLoading(true);
        const AuditRecord = Parse.Object.extend("AuditRecord");
        const obj = new AuditRecord();
        obj.id = id;
        
        try {
            await obj.destroy();
            cloudData = cloudData.filter(i => i.id !== id);
            applyFilters();
            showToast('å·²åˆ é™¤');
        } catch (error) {
            showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
        }
        showLoading(false);
    }

    /* --- UI & å·¥å…· (ä¿æŒä¸å˜) --- */
    
    window.switchTab = async function(tab) {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + tab).classList.add('active');
        if (tab === 'list') {
            if (cloudData.length === 0) await fetchCloudData();
            else applyFilters(); 
        }
    }

    document.getElementById('auditForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const aud = document.getElementById('selectAuditor').value;
        const res = document.getElementById('selectResponsible').value;
        const rsn = document.getElementById('inputReason').value;
        submitRecord(aud, res, rsn);
    });

    function setupFilterListeners() {
        ['filterDateStart', 'filterDateEnd', 'filterKeyword'].forEach(id => {
            document.getElementById(id).addEventListener('input', applyFilters);
        });
    }

    function applyFilters() {
        const start = document.getElementById('filterDateStart').value;
        const end = document.getElementById('filterDateEnd').value;
        const kw = document.getElementById('filterKeyword').value.toLowerCase();

        const filtered = cloudData.filter(item => {
            const t = new Date(item.date).getTime();
            if (start && t < new Date(start).setHours(0,0,0,0)) return false;
            if (end && t > new Date(end).setHours(23,59,59,999)) return false;
            if (kw && !item.auditor.includes(kw) && !item.responsible.includes(kw) && !item.reason.includes(kw)) return false;
            return true;
        });

        renderTable(filtered);
        renderStats(filtered);
    }

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        document.getElementById('emptyTip').style.display = data.length === 0 ? 'block' : 'none';

        data.forEach(item => {
            const d = new Date(item.date);
            const dateStr = `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
            const imgs = item.images.map(src => `<img src="${src}" style="width:30px; height:30px; border-radius:4px; margin-right:4px; cursor:zoom-in; object-fit:cover; border:1px solid #ddd;" onclick="showBigImg('${src}')">`).join('');
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="color:#64748b; font-size:12px;">${dateStr}</td>
                <td><span class="badge badge-auditor">${item.auditor}</span></td>
                <td><span class="badge badge-resp">${item.responsible}</span></td>
                <td>${item.reason}</td>
                <td><div style="display:flex;">${imgs||'-'}</div></td>
                <td><button onclick="deleteCloudRecord('${item.id}')" style="cursor:pointer; border:none; background:none; font-size:16px;">ğŸ—‘</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderStats(data) {
        if (!data.length) { 
            document.getElementById('kpiArea').style.display='none'; 
            document.getElementById('chartArea').style.display='none'; 
            return; 
        }
        document.getElementById('kpiArea').style.display='grid';
        document.getElementById('chartArea').style.display='grid';

        const total = data.length;
        const respCount = {};
        data.forEach(i => respCount[i.responsible] = (respCount[i.responsible]||0)+1);
        const sortedResp = Object.entries(respCount).sort((a,b) => b[1]-a[1]);

        const reasonCount = {};
        data.forEach(i => reasonCount[i.reason] = (reasonCount[i.reason]||0)+1);
        const sortedReason = Object.entries(reasonCount).sort((a,b) => b[1]-a[1]);

        const topResp = sortedResp[0] ? sortedResp[0][0] : '-';
        const topReason = sortedReason[0] ? sortedReason[0][0] : '-';
        
        document.getElementById('kpiArea').innerHTML = `
            <div class="kpi-card theme-blue">
                <div><div class="kpi-icon-wrap">ğŸ“„</div><div class="kpi-label">æ€»è®°å½•æ•°</div><div class="kpi-value">${total}</div></div>
            </div>
            <div class="kpi-card theme-purple">
                <div><div class="kpi-icon-wrap">ğŸ“…</div><div class="kpi-label">ä»Šæ—¥æ–°å¢</div><div class="kpi-value">${data.filter(i=>new Date(i.date).toDateString()===new Date().toDateString()).length}</div></div>
            </div>
            <div class="kpi-card theme-orange">
                <div><div class="kpi-icon-wrap">ğŸ‘¤</div><div class="kpi-label">å¤´å·è´£ä»»äºº</div><div class="kpi-value" style="font-size:20px;">${topResp}</div></div>
            </div>
            <div class="kpi-card theme-pink">
                <div><div class="kpi-icon-wrap">ğŸ”¥</div><div class="kpi-label">é«˜é¢‘é—®é¢˜</div><div class="kpi-value" style="font-size:18px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${topReason}</div></div>
            </div>
        `;

        document.getElementById('statProgressArea').innerHTML = sortedResp.slice(0,5).map((item, idx) => {
            const pct = ((item[1]/total)*100).toFixed(1);
            return `<div class="bar-group"><div class="bar-info"><span>${item[0]}</span><span>${item[1]}</span></div><div class="bar-bg"><div class="bar-fill fill-1" style="width:${pct}%"></div></div></div>`;
        }).join('');

        document.getElementById('statReasonList').innerHTML = sortedReason.slice(0,5).map((item,idx) => `
            <div style="display:flex; padding:8px 0; border-bottom:1px dashed #eee;">
                <div style="width:20px; color:#999; font-weight:bold;">${idx+1}</div>
                <div style="flex:1;">${item[0]}</div>
                <div style="font-weight:bold;">${item[1]}</div>
            </div>
        `).join('');
    }

    window.addSetting = function(type) {
        const id = type==='auditor'?'newAuditorInput':'newResponsibleInput';
        const val = document.getElementById(id).value.trim();
        if(!val) return showToast('è¯·è¾“å…¥å†…å®¹', 'error');
        const list = type==='auditor' ? cloudSettings.auditors : cloudSettings.responsibles;
        if(list.includes(val)) return showToast('å·²å­˜åœ¨', 'error');
        
        list.push(val);
        saveSettingsToCloud();
        renderSettingsUI();
        document.getElementById(id).value = '';
    }
    window.removeSetting = function(type, name) {
        if(!confirm('ç¡®å®šåˆ é™¤?')) return;
        const list = type==='auditor' ? cloudSettings.auditors : cloudSettings.responsibles;
        const idx = list.indexOf(name);
        if(idx>-1) list.splice(idx,1);
        saveSettingsToCloud();
        renderSettingsUI();
    }
    function renderSettingsUI() {
        const render = (arr, t) => arr.map(n => `<div class="tag" onclick="removeSetting('${t}','${n}')">${n} Ã—</div>`).join('');
        document.getElementById('auditorList').innerHTML = render(cloudSettings.auditors, 'auditor');
        document.getElementById('responsibleList').innerHTML = render(cloudSettings.responsibles, 'responsible');
    }
    function updateFormSelects() {
        const fill = (id, arr) => document.getElementById(id).innerHTML = '<option value="">-- é€‰æ‹© --</option>' + arr.map(v=>`<option value="${v}">${v}</option>`).join('');
        fill('selectAuditor', cloudSettings.auditors);
        fill('selectResponsible', cloudSettings.responsibles);
    }

    function setupPasteEvent() {
        document.addEventListener('paste', e => {
            if(!document.getElementById('page-add').classList.contains('active')) return;
            const items = (e.clipboardData||e.originalEvent.clipboardData).items;
            for(let i of items) if(i.kind==='file' && i.type.startsWith('image/')) processFile(i.getAsFile());
        });
    }
    window.handleFiles = function(files) { for(let f of files) processFile(f); }
    function processFile(file) {
        currentFiles.push(file);
        const url = URL.createObjectURL(file);
        const div = document.createElement('div');
        div.className = 'thumb-wrap';
        div.innerHTML = `<img src="${url}"><div class="thumb-rm" onclick="this.parentElement.remove()">Ã—</div>`;
        document.getElementById('previewContainer').appendChild(div);
    }

    function showLoading(show) { document.getElementById('loadingMask').style.display = show ? 'flex' : 'none'; }
    function showToast(msg, type='success') {
        const t = document.getElementById('toast');
        t.innerText = (type==='success'?'âœ… ':'â›” ') + msg;
        t.className = type==='success'?'show':'show error';
        setTimeout(()=>t.className='', 3000);
    }
    window.showBigImg = function(s) { document.getElementById('modalImg').src=s; document.getElementById('imgModal').style.display='flex'; }
    window.fetchCloudData = fetchCloudData; 
    window.exportToExcel = function() {
        if(!cloudData.length) return showToast('æ— æ•°æ®', 'error');
        let csv = "\uFEFFæ—¶é—´,å®¡æ ¸äºº,è´£ä»»äºº,è¯¦æƒ…\n";
        cloudData.forEach(i => csv += `${new Date(i.date).toLocaleString()},${i.auditor},${i.responsible},"${i.reason.replace(/"/g,'""')}"\n`);
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
        a.download = `Data.csv`; a.click();
    }
</script>
</body>
</html>
