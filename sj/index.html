<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¡æ ¸ç³»ç»Ÿ | Supabaseäº‘ç«¯ç‰ˆ</title>
    <!-- å¼•å…¥ Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        /* --- 1. è®¾è®¡å˜é‡ (Aurora UI) --- */
        :root {
            --primary: #6366f1;
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --accent-gradient: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
            --orange-gradient: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%);
            --pink-gradient: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
            --bg-body: #f0f2f5;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: 1px solid rgba(255, 255, 255, 0.8);
            --shadow-sm: 0 4px 6px -1px rgba(0,0,0,0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0,0,0,0.1);
            --text-main: #1e293b; --text-sub: #64748b; --radius-card: 20px;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 20px; color: var(--text-main); min-height: 100vh;
            background-color: var(--bg-body);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(236, 72, 153, 0.1) 0%, transparent 40%);
            background-attachment: fixed;
        }

        .container { max-width: 1000px; margin: 0 auto; padding-bottom: 40px; }

        /* å¯¼èˆª */
        .nav-wrapper { display: flex; justify-content: center; margin-bottom: 30px; }
        .nav-tabs {
            background: rgba(255,255,255,0.8); backdrop-filter: blur(12px);
            padding: 5px; border-radius: 99px; border: var(--glass-border);
            box-shadow: var(--shadow-sm); display: inline-flex; gap: 4px;
        }
        .nav-btn {
            border: none; background: transparent; padding: 10px 24px; border-radius: 99px;
            font-size: 14px; font-weight: 700; color: var(--text-sub); cursor: pointer; transition: 0.3s;
        }
        .nav-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

        /* é¡µé¢åˆ‡æ¢ */
        .page-section { display: none; animation: fadeIn 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* å¡ç‰‡é£æ ¼ */
        .glass-card {
            background: var(--glass-bg); backdrop-filter: blur(20px);
            border: var(--glass-border); border-radius: var(--radius-card);
            padding: 30px; box-shadow: var(--shadow-sm); margin-bottom: 24px;
        }

        h2 { margin: 0 0 24px 0; font-size: 22px; font-weight: 800; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
        h2::before { content:''; width: 6px; height: 24px; background: var(--primary-gradient); border-radius: 10px; display: block; }

        /* KPI æŒ‡æ ‡å¡ */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .kpi-card {
            background: white; border-radius: 16px; padding: 20px;
            box-shadow: var(--shadow-sm); border: 1px solid rgba(255,255,255,0.5);
            display: flex; flex-direction: column; justify-content: space-between;
            transition: transform 0.2s;
        }
        .kpi-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }
        .kpi-icon-wrap {
            width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center;
            font-size: 20px; margin-bottom: 12px;
        }
        .kpi-label { font-size: 13px; color: var(--text-sub); font-weight: 600; text-transform: uppercase; }
        .kpi-value { font-size: 26px; font-weight: 800; color: var(--text-main); margin-top: 4px; letter-spacing: -1px; }
        .kpi-trend { font-size: 12px; margin-top: 8px; font-weight: 500; }
        
        .theme-blue .kpi-icon-wrap { background: #eff6ff; color: #3b82f6; }
        .theme-purple .kpi-icon-wrap { background: #f5f3ff; color: #8b5cf6; }
        .theme-orange .kpi-icon-wrap { background: #fff7ed; color: #f97316; }
        .theme-pink .kpi-icon-wrap { background: #fdf2f8; color: #ec4899; }

        /* å›¾è¡¨åŒºåŸŸ */
        .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px; margin-bottom: 24px; }
        .chart-card { background: white; border-radius: var(--radius-card); padding: 24px; box-shadow: var(--shadow-sm); }
        .chart-header { display: flex; justify-content: space-between; margin-bottom: 20px; font-weight: 700; font-size: 15px; }
        
        .bar-group { margin-bottom: 16px; }
        .bar-info { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px; font-weight: 600; }
        .bar-bg { height: 8px; background: #f1f5f9; border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 4px; width: 0; transition: width 1s ease-out; }
        .fill-1 { background: var(--primary-gradient); }
        .fill-2 { background: var(--accent-gradient); }
        .fill-3 { background: var(--orange-gradient); }
        .fill-other { background: #cbd5e1; }

        .rank-list { counter-reset: rank; }
        .rank-row { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px dashed #f1f5f9; }
        .rank-idx { 
            width: 24px; height: 24px; border-radius: 6px; background: #f1f5f9; color: #64748b;
            display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 800; margin-right: 12px;
        }
        .rank-row:nth-child(1) .rank-idx { background: #fef3c7; color: #d97706; } 
        .rank-name { flex: 1; font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .rank-val { font-weight: 700; color: var(--text-main); background: #f8fafc; padding: 2px 8px; border-radius: 6px; font-size: 12px; }

        /* è¡¨å• */
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 12px; font-weight: 700; color: var(--text-sub); text-transform: uppercase; }
        .form-control {
            width: 100%; padding: 14px; font-size: 15px; border: 1px solid #e2e8f0; border-radius: 12px;
            background: rgba(255,255,255,0.8); transition: 0.2s;
        }
        textarea.form-control { min-height: 100px; }

        .upload-zone {
            border: 2px dashed #cbd5e1; border-radius: 16px; padding: 30px; text-align: center; cursor: pointer;
            background: rgba(248, 250, 252, 0.5); transition: 0.3s;
        }
        .upload-zone:hover { border-color: var(--primary); background: #eef2ff; }
        
        .btn-main {
            width: 100%; padding: 16px; border: none; border-radius: 14px;
            background: var(--primary-gradient); color: white; font-size: 16px; font-weight: 700;
            cursor: pointer; box-shadow: 0 8px 20px -5px rgba(99, 102, 241, 0.4); transition: 0.2s;
        }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 12px 25px -5px rgba(99, 102, 241, 0.5); }

        /* ç­›é€‰ä¸è¡¨æ ¼ */
        .filter-bar { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; align-items: flex-end; }
        .btn-tool { padding: 10px 18px; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; border: 1px solid transparent; background: white; }
        .btn-export { background: #ecfdf5; color: #047857; }

        .table-box { background: white; border-radius: 16px; overflow: hidden; box-shadow: var(--shadow-sm); }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 16px; background: #f8fafc; font-size: 12px; color: var(--text-sub); font-weight: 700; text-transform: uppercase; }
        td { padding: 16px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; }
        .badge-auditor { background: #eff6ff; color: #2563eb; }
        .badge-resp { background: #fff1f2; color: #e11d48; }

        /* ç»„ä»¶ */
        #loadingMask { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(5px); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        #toast { position: fixed; top: 20px; right: 20px; z-index: 5000; background: white; padding: 16px 24px; border-radius: 14px; box-shadow: var(--shadow-lg); border-left: 5px solid var(--primary); transform: translateX(150%); transition: 0.4s; }
        #toast.show { transform: translateX(0); }
        
        #uniModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 4000; justify-content: center; align-items: center; }
        .modal-body { background: white; padding: 30px; border-radius: 20px; text-align: center; width: 90%; max-width: 350px; }
        .modal-input { width: 100%; padding: 10px; margin: 15px 0; border: 2px solid #e2e8f0; border-radius: 8px; text-align: center; }
        .modal-btns { display: flex; gap: 10px; margin-top: 15px; }
        .modal-btn { flex: 1; padding: 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
        .btn-confirm { background: var(--primary); color: white; }

        .preview-box { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .thumb-wrap { position: relative; width: 70px; height: 70px; border-radius: 10px; overflow: hidden; }
        .thumb-wrap img { width: 100%; height: 100%; object-fit: cover; }
        .thumb-rm { position: absolute; inset: 0; background: rgba(0,0,0,0.5); color: white; display: flex; justify-content: center; align-items: center; opacity: 0; cursor: pointer; }
        .thumb-wrap:hover .thumb-rm { opacity: 1; }
        
        #imgModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 5000; justify-content: center; align-items: center; }
        #imgModal img { max-width: 90%; max-height: 90%; border-radius: 10px; }

        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .tag-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px; }
        .tag { background: #f1f5f9; padding: 6px 12px; border-radius: 8px; font-size: 13px; cursor: default; }
        .tag span { color: #94a3b8; margin-left: 6px; cursor: pointer; font-weight: bold; }
        .tag span:hover { color: #ef4444; }

        @media (max-width: 600px) { .form-row { grid-template-columns: 1fr; } .glass-card { padding: 20px; } }
    </style>
</head>
<body>

<!-- Loading -->
<div id="loadingMask">
    <div class="spinner"></div>
    <div style="margin-top:15px; font-weight:600; color:#64748b;">æ•°æ®åŒæ­¥ä¸­...</div>
</div>

<div class="container">
    <div class="nav-wrapper">
        <div class="nav-tabs">
            <button class="nav-btn active" onclick="switchTab('add')">âœï¸ é—®é¢˜ç™»è®°</button>
            <button class="nav-btn" onclick="switchTab('list')">â˜ï¸ äº‘ç«¯æ•°æ®</button>
            <button class="nav-btn" onclick="switchTab('settings')">âš™ï¸ å…¨å±€é…ç½®</button>
        </div>
    </div>

    <!-- 1. ç™»è®° -->
    <div id="page-add" class="page-section active">
        <div class="glass-card">
            <h2>é—®é¢˜ç™»è®°</h2>
            <form id="auditForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>å®¡æ ¸äººå‘˜</label>
                        <select id="selectAuditor" class="form-control" required><option value="">åŠ è½½ä¸­...</option></select>
                    </div>
                    <div class="form-group">
                        <label>è´£ä»»å½’å±</label>
                        <select id="selectResponsible" class="form-control" required><option value="">åŠ è½½ä¸­...</option></select>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom:20px;">
                    <label>å¼‚å¸¸è¯¦æƒ…</label>
                    <textarea id="inputReason" class="form-control" placeholder="è¯·è¯¦ç»†æè¿°..." required></textarea>
                </div>
                <div class="form-group" style="margin-bottom:30px;">
                    <label>å‡­è¯ä¸Šä¼  (äº‘ç«¯åŒæ­¥)</label>
                    <input type="file" id="fileInput" multiple accept="image/*" style="display:none;" onchange="handleFiles(this.files)">
                    <div class="upload-zone" id="pasteArea" onclick="document.getElementById('fileInput').click()">
                        ğŸ“¸ ç‚¹å‡»ä¸Šä¼  æˆ– Ctrl+V ç²˜è´´
                    </div>
                    <div class="preview-box" id="previewContainer"></div>
                </div>
                <button type="submit" class="btn-main">æäº¤åˆ°äº‘ç«¯</button>
            </form>
        </div>
    </div>

    <!-- 2. æ•°æ® -->
    <div id="page-list" class="page-section">
        <div class="kpi-grid" id="kpiArea"></div>
        <div class="chart-grid" id="chartArea" style="display:none;">
            <div class="chart-card">
                <div class="chart-header">ğŸ† è´£ä»»å æ¯”</div>
                <div id="statProgressArea"></div>
            </div>
            <div class="chart-card">
                <div class="chart-header">ğŸ”¥ é«˜é¢‘é—®é¢˜</div>
                <div id="statReasonList" class="rank-list"></div>
            </div>
        </div>
        <div class="glass-card">
            <div class="filter-bar">
                <div style="flex:1"><input type="date" id="filterDateStart" class="form-control"></div>
                <div style="flex:1"><input type="date" id="filterDateEnd" class="form-control"></div>
                <div style="flex:1"><input type="text" id="filterKeyword" class="form-control" placeholder="æœç´¢..."></div>
                <button class="btn-tool" onclick="fetchCloudData()">ğŸ”„ åˆ·æ–°</button>
                <button class="btn-tool btn-export" onclick="exportToExcel()">ğŸ“¥ å¯¼å‡º</button>
            </div>
            <div style="overflow-x: auto;">
                <table id="dataTable">
                    <thead><tr><th>æ—¶é—´</th><th>å®¡æ ¸äºº</th><th>è´£ä»»äºº</th><th>è¯¦æƒ…</th><th>å›¾</th><th>æ“ä½œ</th></tr></thead>
                    <tbody id="tableBody"></tbody>
                </table>
                <div id="emptyTip" style="text-align:center; padding:30px; display:none;">æš‚æ— æ•°æ®</div>
            </div>
        </div>
    </div>

    <!-- 3. é…ç½® -->
    <div id="page-settings" class="page-section">
        <div class="glass-card">
            <h3>ğŸ‘¥ å®¡æ ¸äººåå• (äº‘åŒæ­¥)</h3>
            <div style="display:flex; gap:10px;">
                <input type="text" id="newAuditorInput" class="form-control" placeholder="è¾“å…¥å§“å">
                <button class="btn-tool" style="background:black; color:white;" onclick="addSetting('auditor')">ï¼‹</button>
            </div>
            <div id="auditorList" class="tag-list"></div>
        </div>
        <div class="glass-card" style="margin-top:20px;">
            <h3>ğŸ‘¤ è´£ä»»äººåå• (äº‘åŒæ­¥)</h3>
            <div style="display:flex; gap:10px;">
                <input type="text" id="newResponsibleInput" class="form-control" placeholder="è¾“å…¥å§“å">
                <button class="btn-tool" style="background:black; color:white;" onclick="addSetting('responsible')">ï¼‹</button>
            </div>
            <div id="responsibleList" class="tag-list"></div>
        </div>
    </div>
</div>

<!-- å¼¹çª—ç»„ä»¶ -->
<div id="uniModal">
    <div class="modal-body">
        <h3 id="modalTitle">æç¤º</h3>
        <p id="modalDesc">å†…å®¹</p>
        <input type="password" id="modalInput" class="modal-input" placeholder="è¾“å…¥ç®¡ç†å‘˜å¯†ç " style="display:none;">
        <div class="modal-btns">
            <button class="modal-btn" style="background:#f1f5f9;" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="modal-btn btn-confirm" id="modalConfirmBtn">ç¡®å®š</button>
        </div>
    </div>
</div>
<div id="imgModal" onclick="this.style.display='none'"><img id="modalImg" src=""></div>
<div id="toast"></div>

<script>
    /* ================= âš ï¸ é…ç½®åŒºåŸŸ âš ï¸ ================= */
    // è¯·å°†ä¸‹æ–¹çš„ä¿¡æ¯æ›¿æ¢ä¸ºä½  Supabase çš„ API URL å’Œ anon Key
    const SUPABASE_URL = 'https://yakxvfpsbivghmzqinft.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_MeGabPIgWg4Rx2H1holX4Q_Uqk0__oK';
    const ADMIN_PASSWORD = "xinyunchu";  // åˆ é™¤å¯†ç 

    // =======================================================
    const { createClient } = supabase;
    let db = null;
    let currentFiles = []; 
    let localPreviewUrls = [];
    let cloudData = [];
    let cloudSettings = { auditors: [], responsibles: [] };
    let settingsRowId = null;

    document.addEventListener('DOMContentLoaded', async () => {
        // æ£€æŸ¥é…ç½®
        if(SUPABASE_URL.includes('ä½ çš„Project')) {
            alert('âŒ è¯·ç”¨è®°äº‹æœ¬æ‰“å¼€æ–‡ä»¶ï¼Œå¡«å…¥ä½ çš„ Supabase URL å’Œ Keyï¼');
            document.getElementById('loadingMask').style.display='none';
            return;
        }

        try {
            db = createClient(SUPABASE_URL, SUPABASE_KEY);
            showLoading(true);
            await fetchSettings();
            updateFormSelects();
            setupPasteEvent();
            setupFilterListeners();
            showLoading(false);
            showToast('âœ… äº‘ç«¯è¿æ¥æˆåŠŸ');
        } catch(e) {
            alert('è¿æ¥å¤±è´¥ï¼š' + e.message);
            showLoading(false);
        }
    });

    /* ================= Supabase æ ¸å¿ƒé€»è¾‘ ================= */

    // 1. è·å–é…ç½®
    async function fetchSettings() {
        const { data, error } = await db.from('audit_settings').select('*').limit(1);
        if(error) { console.error(error); return; }

        if(data && data.length > 0) {
            cloudSettings = {
                auditors: data[0].auditors || [],
                responsibles: data[0].responsibles || []
            };
            settingsRowId = data[0].id;
        } else {
            // åˆå§‹åŒ–
            const init = { auditors: ["å¼ ä¸‰", "æå››"], responsibles: ["æ‰“åŒ…ç»„", "ç‹äº”"] };
            const { data: newData } = await db.from('audit_settings').insert([init]).select();
            if(newData) {
                cloudSettings = init;
                settingsRowId = newData[0].id;
            }
        }
        renderSettingsUI();
    }

    // 2. ä¿å­˜é…ç½®
    async function saveSettingsToCloud() {
        if (!settingsRowId) return;
        showLoading(true);
        const { error } = await db.from('audit_settings').update({
            auditors: cloudSettings.auditors,
            responsibles: cloudSettings.responsibles
        }).eq('id', settingsRowId);

        if(error) showToast('åŒæ­¥é…ç½®å¤±è´¥', 'error');
        else {
            updateFormSelects();
            showToast('é…ç½®å·²åŒæ­¥');
        }
        showLoading(false);
    }

    // 3. æäº¤è®°å½• (è½¬Base64å­˜å‚¨)
    async function submitRecord(auditor, responsible, reason) {
        showLoading(true);
        try {
            let imageUrls = [];
            // è½¬ Base64
            if (currentFiles.length > 0) {
                const promises = currentFiles.map(file => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = e => resolve(e.target.result);
                        reader.readAsDataURL(file);
                    });
                });
                imageUrls = await Promise.all(promises);
            }

            const { error } = await db.from('audit_record').insert([{
                auditor, responsible, reason, images: imageUrls
            }]);

            if(error) throw error;
            
            document.getElementById('auditForm').reset();
            currentFiles = [];
            localPreviewUrls = [];
            renderPreviews();
            showToast('æäº¤æˆåŠŸï¼');
        } catch (error) {
            console.error(error);
            showToast('æäº¤å¤±è´¥', 'error');
        }
        showLoading(false);
    }

    // 4. è·å–æ•°æ®
    async function fetchCloudData() {
        showLoading(true);
        const { data, error } = await db.from('audit_record').select('*').order('created_at', { ascending: false }).limit(500);
        
        if (error) {
            showToast('è·å–æ•°æ®å¤±è´¥', 'error');
        } else {
            cloudData = data.map(item => ({
                id: item.id,
                date: item.created_at,
                auditor: item.auditor,
                responsible: item.responsible,
                reason: item.reason,
                images: item.images || []
            }));
            applyFilters();
            showToast('æ•°æ®å·²åˆ·æ–°');
        }
        showLoading(false);
    }

    // 5. åˆ é™¤æ•°æ®
    async function deleteCloudRecord(id) {
        showLoading(true);
        const { error } = await db.from('audit_record').delete().eq('id', id);
        if (error) {
            showToast('åˆ é™¤å¤±è´¥', 'error');
        } else {
            cloudData = cloudData.filter(i => i.id !== id);
            applyFilters();
            showToast('å·²åˆ é™¤');
        }
        showLoading(false);
    }

    /* ================= UI é€»è¾‘ ================= */
    
    // Tab åˆ‡æ¢
    window.switchTab = async function(tab) {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + tab).classList.add('active');
        if (tab === 'list') {
            if (cloudData.length === 0) await fetchCloudData();
            else applyFilters(); 
        }
    }

    // æäº¤
    document.getElementById('auditForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const aud = document.getElementById('selectAuditor').value;
        const res = document.getElementById('selectResponsible').value;
        const rsn = document.getElementById('inputReason').value;

        if (currentFiles.length === 0) {
            showDialog({ title: 'ç¡®è®¤', text: 'æœªä¸Šä¼ å›¾ç‰‡ï¼Œç¡®å®šæäº¤å—ï¼Ÿ', onConfirm: () => {
                closeModal(); submitRecord(aud, res, rsn);
            }});
        } else {
            submitRecord(aud, res, rsn);
        }
    });

    // ç­›é€‰
    function setupFilterListeners() {
        ['filterDateStart', 'filterDateEnd', 'filterKeyword'].forEach(id => {
            document.getElementById(id).addEventListener('input', applyFilters);
        });
    }

    function applyFilters() {
        const start = document.getElementById('filterDateStart').value;
        const end = document.getElementById('filterDateEnd').value;
        const kw = document.getElementById('filterKeyword').value.toLowerCase();

        const filtered = cloudData.filter(item => {
            const t = new Date(item.date).getTime();
            if (start && t < new Date(start).setHours(0,0,0,0)) return false;
            if (end && t > new Date(end).setHours(23,59,59,999)) return false;
            if (kw && !item.auditor.includes(kw) && !item.responsible.includes(kw) && !item.reason.includes(kw)) return false;
            return true;
        });

        renderTable(filtered);
        renderStats(filtered);
    }

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        document.getElementById('emptyTip').style.display = data.length === 0 ? 'block' : 'none';

        data.forEach(item => {
            const d = new Date(item.date);
            const dateStr = `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
            const imgs = item.images.map(src => `<img src="${src}" style="width:30px; height:30px; border-radius:4px; margin-right:4px; cursor:zoom-in; object-fit:cover;" onclick="showBigImg('${src}')">`).join('');
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="color:#64748b; font-size:12px;">${dateStr}</td>
                <td><span class="badge badge-auditor">${item.auditor}</span></td>
                <td><span class="badge badge-resp">${item.responsible}</span></td>
                <td>${item.reason}</td>
                <td><div style="display:flex;">${imgs||'-'}</div></td>
                <td><button onclick="confirmDelete('${item.id}')" style="cursor:pointer; border:none; background:none; font-size:16px;">ğŸ—‘</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderStats(data) {
        if (!data.length) { 
            document.getElementById('kpiArea').style.display='none'; 
            document.getElementById('chartArea').style.display='none'; 
            return; 
        }
        document.getElementById('kpiArea').style.display='grid';
        document.getElementById('chartArea').style.display='grid';

        const total = data.length;
        const respCount = {};
        data.forEach(i => respCount[i.responsible] = (respCount[i.responsible]||0)+1);
        const sortedResp = Object.entries(respCount).sort((a,b) => b[1]-a[1]);

        const reasonCount = {};
        data.forEach(i => reasonCount[i.reason] = (reasonCount[i.reason]||0)+1);
        const sortedReason = Object.entries(reasonCount).sort((a,b) => b[1]-a[1]);

        const topResp = sortedResp[0] ? sortedResp[0][0] : '-';
        const topReason = sortedReason[0] ? sortedReason[0][0] : '-';
        
        document.getElementById('kpiArea').innerHTML = `
            <div class="kpi-card theme-blue">
                <div><div class="kpi-icon-wrap">ğŸ“„</div><div class="kpi-label">æ€»è®°å½•æ•°</div><div class="kpi-value">${total}</div></div>
                <div class="kpi-trend">å†å²ç´¯è®¡</div>
            </div>
            <div class="kpi-card theme-purple">
                <div><div class="kpi-icon-wrap">ğŸ“…</div><div class="kpi-label">ä»Šæ—¥æ–°å¢</div><div class="kpi-value">${data.filter(i=>new Date(i.date).toDateString()===new Date().toDateString()).length}</div></div>
                <div class="kpi-trend" style="color:#10b981">å®æ—¶æ›´æ–°</div>
            </div>
            <div class="kpi-card theme-orange">
                <div><div class="kpi-icon-wrap">ğŸ‘¤</div><div class="kpi-label">å¤´å·è´£ä»»äºº</div><div class="kpi-value" style="font-size:20px;">${topResp}</div></div>
                <div class="kpi-trend">å æ¯” ${(sortedResp[0] ? (sortedResp[0][1]/total*100).toFixed(0):0)}%</div>
            </div>
            <div class="kpi-card theme-pink">
                <div><div class="kpi-icon-wrap">ğŸ”¥</div><div class="kpi-label">é«˜é¢‘é—®é¢˜</div><div class="kpi-value" style="font-size:18px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${topReason}</div></div>
                <div class="kpi-trend">å‡ºç° ${sortedReason[0]?sortedReason[0][1]:0} æ¬¡</div>
            </div>
        `;

        document.getElementById('statProgressArea').innerHTML = sortedResp.slice(0,5).map((item, idx) => {
            const pct = ((item[1]/total)*100).toFixed(1);
            const fillClass = idx < 4 ? `fill-${idx+1}` : 'fill-other';
            return `<div class="bar-group"><div class="bar-info"><span>${item[0]}</span><span>${item[1]}</span></div><div class="bar-bg"><div class="bar-fill ${fillClass}" style="width:${pct}%"></div></div></div>`;
        }).join('');

        document.getElementById('statReasonList').innerHTML = sortedReason.slice(0,5).map((item,idx) => `
            <div class="rank-row">
                <div class="rank-idx">${idx+1}</div>
                <div class="rank-name">${item[0]}</div>
                <div class="rank-val">${item[1]}æ¬¡</div>
            </div>
        `).join('');
        
        setTimeout(() => document.querySelectorAll('.bar-fill').forEach(e => { const w=e.style.width; e.style.width='0'; setTimeout(()=>e.style.width=w,50) }), 100);
    }

    // è®¾ç½®é€»è¾‘
    window.addSetting = function(type) {
        const id = type==='auditor'?'newAuditorInput':'newResponsibleInput';
        const val = document.getElementById(id).value.trim();
        if(!val) return showToast('è¯·è¾“å…¥å†…å®¹', 'error');
        const list = type==='auditor' ? cloudSettings.auditors : cloudSettings.responsibles;
        if(list.includes(val)) return showToast('å·²å­˜åœ¨', 'error');
        
        list.push(val);
        saveSettingsToCloud();
        renderSettingsUI();
        document.getElementById(id).value = '';
    }
    window.removeSetting = function(type, name) {
        showDialog({ title: 'ç¡®è®¤ç§»é™¤', text: `ç¡®å®šç§»é™¤ "${name}" å—ï¼Ÿ`, onConfirm: () => {
            const list = type==='auditor' ? cloudSettings.auditors : cloudSettings.responsibles;
            const idx = list.indexOf(name);
            if(idx>-1) list.splice(idx,1);
            saveSettingsToCloud();
            renderSettingsUI();
            closeModal();
        }});
    }
    function renderSettingsUI() {
        const render = (arr, t) => (arr||[]).map(n => `<div class="tag">${n}<span onclick="removeSetting('${t}','${n}')">Ã—</span></div>`).join('');
        document.getElementById('auditorList').innerHTML = render(cloudSettings.auditors, 'auditor');
        document.getElementById('responsibleList').innerHTML = render(cloudSettings.responsibles, 'responsible');
    }
    function updateFormSelects() {
        const fill = (id, arr) => document.getElementById(id).innerHTML = '<option value="">-- é€‰æ‹© --</option>' + (arr||[]).map(v=>`<option value="${v}">${v}</option>`).join('');
        fill('selectAuditor', cloudSettings.auditors);
        fill('selectResponsible', cloudSettings.responsibles);
    }

    // æ–‡ä»¶å¤„ç†
    function setupPasteEvent() {
        document.addEventListener('paste', e => {
            if(!document.getElementById('page-add').classList.contains('active')) return;
            const items = (e.clipboardData||e.originalEvent.clipboardData).items;
            for(let i of items) if(i.kind==='file' && i.type.startsWith('image/')) processFile(i.getAsFile());
        });
    }
    window.handleFiles = function(files) { for(let f of files) processFile(f); }
    function processFile(file) {
        currentFiles.push(file);
        const url = URL.createObjectURL(file);
        localPreviewUrls.push(url);
        renderPreviews();
    }
    function renderPreviews() {
        document.getElementById('previewContainer').innerHTML = localPreviewUrls.map((src,i) => 
            `<div class="thumb-wrap"><img src="${src}"><div class="thumb-rm" onclick="removeFile(${i})">Ã—</div></div>`
        ).join('');
    }
    window.removeFile = function(i) {
        currentFiles.splice(i,1); localPreviewUrls.splice(i,1); renderPreviews();
    }

    // åˆ é™¤éªŒè¯
    window.confirmDelete = function(id) {
        showDialog({
            title: 'å®‰å…¨éªŒè¯', text: 'åˆ é™¤ä¸å¯æ¢å¤ï¼Œè¯·è¾“å…¥å¯†ç ï¼š', type: 'password',
            onConfirm: (pwd) => {
                if (pwd === ADMIN_PASSWORD) {
                    deleteCloudRecord(id);
                    closeModal();
                } else {
                    showToast('å¯†ç é”™è¯¯', 'error');
                }
            }
        });
    }

    // å·¥å…·å‡½æ•°
    function showLoading(show) { document.getElementById('loadingMask').style.display = show ? 'flex' : 'none'; }
    function showToast(msg, type='success') {
        const t = document.getElementById('toast');
        t.innerText = (type==='success'?'âœ… ':'â›” ') + msg;
        t.className = type==='success'?'show':'show error';
        setTimeout(()=>t.className='', 3000);
    }
    window.showDialog = function({title, text, type='confirm', onConfirm}) {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalDesc').innerText = text;
        const inp = document.getElementById('modalInput');
        inp.value=''; inp.style.display=type==='password'?'block':'none';
        document.getElementById('uniModal').style.display='flex';
        const btn = document.getElementById('modalConfirmBtn');
        const newBtn = btn.cloneNode(true); btn.parentNode.replaceChild(newBtn, btn);
        newBtn.onclick = () => type==='password'?onConfirm(inp.value):onConfirm();
        if(type==='password') inp.focus();
    }
    window.closeModal = function() { document.getElementById('uniModal').style.display='none'; }
    window.showBigImg = function(s) { document.getElementById('modalImg').src=s; document.getElementById('imgModal').style.display='flex'; }
    window.fetchCloudData = fetchCloudData; 
    window.exportToExcel = function() {
        if(!cloudData.length) return showToast('æ— æ•°æ®', 'error');
        let csv = "\uFEFFæ—¶é—´,å®¡æ ¸äºº,è´£ä»»äºº,è¯¦æƒ…,å›¾\n";
        // ä½¿ç”¨å½“å‰ç­›é€‰åçš„æ•°æ®
        const start = document.getElementById('filterDateStart').value;
        const end = document.getElementById('filterDateEnd').value;
        const kw = document.getElementById('filterKeyword').value.toLowerCase();
        const filtered = cloudData.filter(item => {
            const t = new Date(item.date).getTime();
            if (start && t < new Date(start).setHours(0,0,0,0)) return false;
            if (end && t > new Date(end).setHours(23,59,59,999)) return false;
            if (kw && !item.auditor.includes(kw) && !item.responsible.includes(kw) && !item.reason.includes(kw)) return false;
            return true;
        });
        filtered.forEach(i => csv += `${new Date(i.date).toLocaleString()},${i.auditor},${i.responsible},"${i.reason.replace(/"/g,'""')}",${i.images.length}\n`);
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
        a.download = `Export_${new Date().toISOString().split('T')[0]}.csv`; a.click();
    }
</script>
</body>
</html>
